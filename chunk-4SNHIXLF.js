import{Za as w,bb as b,f as C,g as r,h as S,k as v,l as g,n as l,q as x,t as m}from"./chunk-YCOLXJFA.js";import{a as o,b as d}from"./chunk-POLL2CVR.js";var M=(()=>{class p{parseAmount(e){if(e==null)return 0;if(typeof e=="number"&&!Number.isNaN(e))return e;let t=String(e).trim().replace(",","."),s=parseFloat(t);return Number.isNaN(s)?0:s}constructor(e,t){this.authService=e,this.apiService=t,this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[],this.expensesCache$=null,this.budgetsCache$=null,this.savingsGoalsCache$=null,this.salariesCache$=null,this.categoriesCache$=null,this.walletCardsCache$=null,this.authService.currentUser$.pipe(v()).subscribe(s=>{s!==null?this.loadAll():(this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[],this.expensesCache$=null,this.budgetsCache$=null,this.savingsGoalsCache$=null,this.salariesCache$=null,this.categoriesCache$=null,this.walletCardsCache$=null)})}getCustomCategories(){return[...this.customCategories]}getCustomCategoriesObservable(){return this.categoriesCache$||(this.categoriesCache$=this.apiService.get("/finance/categories").pipe(r(e=>e.data||[]),l(e=>{this.customCategories=e.map(t=>d(o({},t),{id:typeof t.id=="number"?t.id:parseInt(String(t.id),10)}))}),g(1))),this.categoriesCache$}addCustomCategory(e){let t=e?.trim()||"";return t?this.apiService.post("/finance/categories",{name:t}).pipe(r(s=>({data:s.data,created:s.created!==!1})),l(({data:s})=>{let a=d(o({},s),{id:typeof s.id=="number"?s.id:parseInt(String(s.id),10)});this.customCategories.some(n=>n.id===a.id)||this.customCategories.push(a),this.categoriesCache$=null})):C({data:{},created:!1})}removeCustomCategory(e){let t=typeof e=="string"?parseInt(e,10):e;return this.apiService.delete(`/finance/categories/${t}`).pipe(r(s=>s.success),l(s=>{s&&(this.customCategories=this.customCategories.filter(a=>a.id!==t),this.categoriesCache$=null)}))}getExpenses(){return[...this.expenses]}getExpensesObservable(){return this.expensesCache$||(this.expensesCache$=this.apiService.get("/finance/expenses").pipe(r(e=>e.data||[]),l(e=>this.expenses=e.map(t=>d(o({},t),{id:t.id.toString(),date:new Date(t.date),amount:this.parseAmount(t.amount)}))),g(1))),this.expensesCache$}getExpensesForCard(e){let t=e!=null?{walletCardId:e}:void 0;return this.apiService.get("/finance/expenses",t).pipe(r(s=>(s.data||[]).map(a=>d(o({},a),{id:a.id.toString(),date:new Date(a.date),amount:this.parseAmount(a.amount)}))),l(s=>{this.expenses=s,this.expensesCache$=null}))}addExpense(e){let t=o({},e);return e.walletCardId!=null&&(t.walletCardId=typeof e.walletCardId=="string"?parseInt(e.walletCardId,10):e.walletCardId),this.apiService.post("/finance/expenses",t).pipe(r(s=>s.data),l(s=>{this.expenses.push(d(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.expensesCache$=null}))}updateExpense(e,t){return this.apiService.put(`/finance/expenses/${e}`,t).pipe(r(s=>s.data),l(s=>{let a=this.expenses.findIndex(n=>n.id===e);a!==-1&&(this.expenses[a]=d(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.expensesCache$=null}))}deleteExpense(e){return this.apiService.delete(`/finance/expenses/${e}`).pipe(r(t=>t.success),l(()=>{let t=this.expenses.findIndex(s=>s.id===e);t!==-1&&this.expenses.splice(t,1),this.expensesCache$=null}))}getTotalExpenses(){return this.expenses.reduce((e,t)=>e+this.parseAmount(t.amount),0)}getExpensesByCategory(e){return this.expenses.filter(t=>t.category===e)}getBudgets(){return[...this.budgets]}getBudgetsObservable(){return this.budgetsCache$||(this.budgetsCache$=this.apiService.get("/finance/budgets").pipe(r(e=>e.data||[]),l(e=>this.budgets=e.map(t=>d(o({},t),{id:t.id.toString(),limit:this.parseAmount(t.limit),spent:this.parseAmount(t.spent)}))),g(1))),this.budgetsCache$}addBudget(e){return this.apiService.post("/finance/budgets",e).pipe(r(t=>t.data),l(t=>{this.budgets.push(d(o({},t),{id:t.id.toString()})),this.budgetsCache$=null}))}updateBudget(e,t){return this.apiService.put(`/finance/budgets/${e}`,t).pipe(r(s=>s.data),l(s=>{let a=this.budgets.findIndex(n=>n.id===e);a!==-1&&(this.budgets[a]=d(o({},s),{id:s.id.toString()})),this.budgetsCache$=null}))}deleteBudget(e){return this.apiService.delete(`/finance/budgets/${e}`).pipe(r(t=>t.success),l(()=>{let t=this.budgets.findIndex(s=>s.id===e);t!==-1&&this.budgets.splice(t,1),this.budgetsCache$=null}))}getSavingsGoals(){return[...this.savingsGoals]}getSavingsGoalsObservable(){return this.savingsGoalsCache$||(this.savingsGoalsCache$=this.apiService.get("/finance/savings-goals").pipe(r(e=>e.data||[]),l(e=>this.savingsGoals=e.map(t=>d(o({},t),{id:t.id.toString(),deadline:t.deadline?new Date(t.deadline):void 0,targetAmount:this.parseAmount(t.targetAmount),currentAmount:this.parseAmount(t.currentAmount)}))),g(1))),this.savingsGoalsCache$}updateSavingsGoal(e,t){return this.apiService.put(`/finance/savings-goals/${e}`,t).pipe(r(s=>s.data),l(s=>{let a=this.savingsGoals.findIndex(n=>n.id===e);a!==-1&&(this.savingsGoals[a]=d(o({},s),{id:s.id.toString(),deadline:s.deadline?new Date(s.deadline):void 0})),this.savingsGoalsCache$=null}))}deleteSavingsGoal(e){return this.apiService.delete(`/finance/savings-goals/${e}`).pipe(r(t=>t.success),l(()=>{let t=this.savingsGoals.findIndex(s=>s.id===e);t!==-1&&this.savingsGoals.splice(t,1),this.savingsGoalsCache$=null}))}getSalaries(){return[...this.salaries]}getSalariesObservable(){return this.salariesCache$||(this.salariesCache$=this.apiService.get("/finance/salaries").pipe(r(e=>e.data||[]),l(e=>this.salaries=e.map(t=>d(o({},t),{id:t.id.toString(),date:new Date(t.date),amount:this.parseAmount(t.amount)}))),g(1))),this.salariesCache$}getSalariesForCard(e){let t=e!=null?{walletCardId:e}:void 0;return this.apiService.get("/finance/salaries",t).pipe(r(s=>(s.data||[]).map(a=>d(o({},a),{id:a.id.toString(),date:new Date(a.date),amount:this.parseAmount(a.amount)}))),l(s=>{this.salaries=s,this.salariesCache$=null}))}addSalary(e){let t=o({},e);return e.walletCardId!=null&&(t.walletCardId=typeof e.walletCardId=="string"?parseInt(e.walletCardId,10):e.walletCardId),this.apiService.post("/finance/salaries",t).pipe(r(s=>s.data),l(s=>{this.salaries.push(d(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.salariesCache$=null}))}updateSalary(e,t){return this.apiService.put(`/finance/salaries/${e}`,t).pipe(r(s=>s.data),l(s=>{let a=this.salaries.findIndex(n=>n.id===e);a!==-1&&(this.salaries[a]=d(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.salariesCache$=null}))}deleteSalary(e){return this.apiService.delete(`/finance/salaries/${e}`).pipe(r(t=>t.success),l(()=>{let t=this.salaries.findIndex(s=>s.id===e);t!==-1&&this.salaries.splice(t,1),this.salariesCache$=null}))}getTotalIncome(){return this.salaries.reduce((e,t)=>e+t.amount,0)}getTotalExpensesForMonth(e,t){return this.expenses.filter(s=>{let a=new Date(s.date);return a.getFullYear()===e&&a.getMonth()===t}).reduce((s,a)=>s+this.parseAmount(a.amount),0)}getMonthlySalary(){let e=new Date;return this.getSalaryForMonth(e.getFullYear(),e.getMonth())}getSalaryForMonth(e,t){let a=this.salaries.filter(i=>{let h=new Date(i.date);return i.period==="monthly"&&h.getFullYear()===e&&h.getMonth()===t}).reduce((i,h)=>i+this.parseAmount(h.amount),0),u=this.salaries.filter(i=>{let h=new Date(i.date);return i.period==="yearly"&&h.getFullYear()===e}).reduce((i,h)=>i+this.parseAmount(h.amount)/12,0);return a+u}getSalariesForMonth(e,t){return this.salaries.filter(s=>{let a=new Date(s.date),n=s.period==="monthly"&&a.getFullYear()===e&&a.getMonth()===t,u=s.period==="yearly"&&a.getFullYear()===e;return n||u})}getMonthlyBudget(){return this.budgets.filter(t=>t.period==="monthly").reduce((t,s)=>t+this.parseAmount(s.limit),0)}getRemainingBudget(e,t){let s=e!==void 0&&t!==void 0?{year:e,month:t}:{year:new Date().getFullYear(),month:new Date().getMonth()},a=this.getTotalExpensesForMonth(s.year,s.month);return this.getMonthlyBudget()-a}getCumulativeBalanceBeforeMonth(e,t){let s=0,a=new Set;this.salaries.forEach(u=>{let i=new Date(u.date),h=`${i.getFullYear()}-${i.getMonth()}`;(i.getFullYear()<e||i.getFullYear()===e&&i.getMonth()<t)&&a.add(h)}),this.expenses.forEach(u=>{let i=new Date(u.date),h=`${i.getFullYear()}-${i.getMonth()}`;(i.getFullYear()<e||i.getFullYear()===e&&i.getMonth()<t)&&a.add(h)});let n=Array.from(a).sort();for(let u of n){let[i,h]=u.split("-").map(Number),c=this.getSalaryForMonth(i,h),f=this.getTotalExpensesForMonth(i,h);s+=c-f}return s}getRemainingBalance(e,t){let s=e!==void 0&&t!==void 0?{year:e,month:t}:{year:new Date().getFullYear(),month:new Date().getMonth()},a=this.getCumulativeBalanceBeforeMonth(s.year,s.month),n=this.getSalaryForMonth(s.year,s.month),u=this.getTotalExpensesForMonth(s.year,s.month);return a+n-u}getSavingsSuggestions(e,t){let s=[],a=e!==void 0&&t!==void 0?{year:e,month:t}:{year:new Date().getFullYear(),month:new Date().getMonth()},n=this.getTotalExpensesForMonth(a.year,a.month),u=this.expenses.filter(i=>{let h=new Date(i.date);return h.getFullYear()===a.year&&h.getMonth()===a.month});return n>0&&(u.filter(c=>c.category==="food").reduce((c,f)=>c+this.parseAmount(f.amount),0)>n*.3&&s.push("Consid\xE9rez r\xE9duire les d\xE9penses alimentaires en cuisinant plus \xE0 la maison"),u.filter(c=>c.category==="leisure").reduce((c,f)=>c+this.parseAmount(f.amount),0)>n*.2&&s.push("R\xE9duisez les d\xE9penses de loisirs en cherchant des activit\xE9s gratuites")),s}getExpensesForMonth(e,t){return this.expenses.filter(s=>{let a=new Date(s.date);return a.getFullYear()===e&&a.getMonth()===t})}addSavingsGoal(e){let t="currentAmount"in e?d(o({},e),{currentAmount:e.currentAmount||0}):d(o({},e),{currentAmount:0});return this.apiService.post("/finance/savings-goals",t).pipe(r(s=>s.data),l(s=>{this.savingsGoals.push(d(o({},s),{id:s.id.toString(),deadline:s.deadline?new Date(s.deadline):void 0})),this.savingsGoalsCache$=null}))}normalizeWalletCard(e){let t=e,s=typeof e.id=="number"?e.id.toString():e.id,a=!!t.isDefault,n=t.color,u=n==null?null:String(n).trim()||null,i=t.currency,h=i==null?null:String(i).trim()||null;return d(o({},e),{id:s,isDefault:a,color:u,currency:h})}getWalletCards(){return this.walletCards.map(e=>d(o({},e),{id:typeof e.id=="number"?e.id.toString():e.id}))}getWalletCardsObservable(){return this.walletCardsCache$||(this.walletCardsCache$=this.apiService.get("/finance/wallet-cards").pipe(r(e=>(e.data||[]).map(t=>this.normalizeWalletCard(t))),l(e=>{this.walletCards=e}),g(1))),this.walletCardsCache$}getDefaultWalletCard(){return this.walletCards.find(t=>t.isDefault)??this.walletCards[0]??null}addWalletCard(e){return this.apiService.post("/finance/wallet-cards",{name:e.name??void 0,holderName:e.holderName,cardNumber:e.cardNumber,expiryDate:e.expiryDate,rib:e.rib??void 0,currency:e.currency??void 0,color:e.color??void 0,isDefault:e.isDefault}).pipe(r(t=>t.data),l(t=>{let s=this.normalizeWalletCard(t);this.walletCards.some(a=>String(a.id)===String(s.id))?this.walletCards=this.walletCards.map(a=>String(a.id)===String(s.id)?s:a):this.walletCards=[...this.walletCards,s],this.walletCardsCache$=null}))}updateWalletCard(e,t){return this.apiService.put(`/finance/wallet-cards/${e}`,t).pipe(r(s=>s.data),l(s=>{let a=this.normalizeWalletCard(s);this.walletCards=this.walletCards.map(n=>String(n.id)===String(e)?a:n),t.isDefault===!0&&(this.walletCards=this.walletCards.map(n=>d(o({},n),{isDefault:String(n.id)===String(e)}))),this.walletCardsCache$=null}))}deleteWalletCard(e){return this.apiService.delete(`/finance/wallet-cards/${e}`).pipe(r(t=>t.success),l(t=>{t&&(this.walletCards=this.walletCards.filter(s=>String(s.id)!==e),this.walletCardsCache$=null)}))}invalidateWalletCardsCache(){this.walletCardsCache$=null}loadAll(){this.authService.isAuthenticated()?S({budgets:this.getBudgetsObservable(),savingsGoals:this.getSavingsGoalsObservable(),categories:this.getCustomCategoriesObservable(),walletCards:this.getWalletCardsObservable()}).subscribe({next:()=>{let e=this.getDefaultWalletCard(),t=e?.id!=null?String(e.id):null;t&&(this.getExpensesForCard(t).subscribe({error:()=>{}}),this.getSalariesForCard(t).subscribe({error:()=>{}}))},error:e=>console.error("Error loading finance data:",e)}):(this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[])}static{this.\u0275fac=function(t){return new(t||p)(m(b),m(w))}}static{this.\u0275prov=x({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})();export{M as a};
