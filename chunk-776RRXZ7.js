import{Za as b,bb as $,f as C,g as r,h as S,k as v,l as g,n as l,q as x,t as m}from"./chunk-2GVYHNTM.js";import{a as o,b as h}from"./chunk-POLL2CVR.js";var F=(()=>{class p{parseAmount(t){if(t==null)return 0;if(typeof t=="number"&&!Number.isNaN(t))return t;let e=String(t).trim().replace(",","."),s=parseFloat(e);return Number.isNaN(s)?0:s}constructor(t,e){this.authService=t,this.apiService=e,this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[],this.expensesCache$=null,this.budgetsCache$=null,this.savingsGoalsCache$=null,this.salariesCache$=null,this.categoriesCache$=null,this.walletCardsCache$=null,this.authService.currentUser$.pipe(v()).subscribe(s=>{s!==null?this.loadAll():(this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[],this.expensesCache$=null,this.budgetsCache$=null,this.savingsGoalsCache$=null,this.salariesCache$=null,this.categoriesCache$=null,this.walletCardsCache$=null)})}getCustomCategories(){return[...this.customCategories]}getCustomCategoriesObservable(){return this.categoriesCache$||(this.categoriesCache$=this.apiService.get("/finance/categories").pipe(r(t=>t.data||[]),l(t=>{this.customCategories=t.map(e=>h(o({},e),{id:typeof e.id=="number"?e.id:parseInt(String(e.id),10)}))}),g(1))),this.categoriesCache$}addCustomCategory(t){let e=t?.trim()||"";return e?this.apiService.post("/finance/categories",{name:e}).pipe(r(s=>({data:s.data,created:s.created!==!1})),l(({data:s})=>{let i=h(o({},s),{id:typeof s.id=="number"?s.id:parseInt(String(s.id),10)});this.customCategories.some(n=>n.id===i.id)||this.customCategories.push(i),this.categoriesCache$=null})):C({data:{},created:!1})}removeCustomCategory(t){let e=typeof t=="string"?parseInt(t,10):t;return this.apiService.delete(`/finance/categories/${e}`).pipe(r(s=>s.success),l(s=>{s&&(this.customCategories=this.customCategories.filter(i=>i.id!==e),this.categoriesCache$=null)}))}getExpenses(){return[...this.expenses]}getExpensesObservable(){return this.expensesCache$||(this.expensesCache$=this.apiService.get("/finance/expenses").pipe(r(t=>t.data||[]),l(t=>this.expenses=t.map(e=>h(o({},e),{id:e.id.toString(),date:new Date(e.date),amount:this.parseAmount(e.amount)}))),g(1))),this.expensesCache$}addExpense(t){return this.apiService.post("/finance/expenses",t).pipe(r(e=>e.data),l(e=>{this.expenses.push(h(o({},e),{id:e.id.toString(),date:new Date(e.date)})),this.expensesCache$=null}))}updateExpense(t,e){return this.apiService.put(`/finance/expenses/${t}`,e).pipe(r(s=>s.data),l(s=>{let i=this.expenses.findIndex(n=>n.id===t);i!==-1&&(this.expenses[i]=h(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.expensesCache$=null}))}deleteExpense(t){return this.apiService.delete(`/finance/expenses/${t}`).pipe(r(e=>e.success),l(()=>{let e=this.expenses.findIndex(s=>s.id===t);e!==-1&&this.expenses.splice(e,1),this.expensesCache$=null}))}getTotalExpenses(){return this.expenses.reduce((t,e)=>t+this.parseAmount(e.amount),0)}getExpensesByCategory(t){return this.expenses.filter(e=>e.category===t)}getBudgets(){return[...this.budgets]}getBudgetsObservable(){return this.budgetsCache$||(this.budgetsCache$=this.apiService.get("/finance/budgets").pipe(r(t=>t.data||[]),l(t=>this.budgets=t.map(e=>h(o({},e),{id:e.id.toString(),limit:this.parseAmount(e.limit),spent:this.parseAmount(e.spent)}))),g(1))),this.budgetsCache$}addBudget(t){return this.apiService.post("/finance/budgets",t).pipe(r(e=>e.data),l(e=>{this.budgets.push(h(o({},e),{id:e.id.toString()})),this.budgetsCache$=null}))}updateBudget(t,e){return this.apiService.put(`/finance/budgets/${t}`,e).pipe(r(s=>s.data),l(s=>{let i=this.budgets.findIndex(n=>n.id===t);i!==-1&&(this.budgets[i]=h(o({},s),{id:s.id.toString()})),this.budgetsCache$=null}))}deleteBudget(t){return this.apiService.delete(`/finance/budgets/${t}`).pipe(r(e=>e.success),l(()=>{let e=this.budgets.findIndex(s=>s.id===t);e!==-1&&this.budgets.splice(e,1),this.budgetsCache$=null}))}getSavingsGoals(){return[...this.savingsGoals]}getSavingsGoalsObservable(){return this.savingsGoalsCache$||(this.savingsGoalsCache$=this.apiService.get("/finance/savings-goals").pipe(r(t=>t.data||[]),l(t=>this.savingsGoals=t.map(e=>h(o({},e),{id:e.id.toString(),deadline:e.deadline?new Date(e.deadline):void 0,targetAmount:this.parseAmount(e.targetAmount),currentAmount:this.parseAmount(e.currentAmount)}))),g(1))),this.savingsGoalsCache$}updateSavingsGoal(t,e){return this.apiService.put(`/finance/savings-goals/${t}`,e).pipe(r(s=>s.data),l(s=>{let i=this.savingsGoals.findIndex(n=>n.id===t);i!==-1&&(this.savingsGoals[i]=h(o({},s),{id:s.id.toString(),deadline:s.deadline?new Date(s.deadline):void 0})),this.savingsGoalsCache$=null}))}deleteSavingsGoal(t){return this.apiService.delete(`/finance/savings-goals/${t}`).pipe(r(e=>e.success),l(()=>{let e=this.savingsGoals.findIndex(s=>s.id===t);e!==-1&&this.savingsGoals.splice(e,1),this.savingsGoalsCache$=null}))}getSalaries(){return[...this.salaries]}getSalariesObservable(){return this.salariesCache$||(this.salariesCache$=this.apiService.get("/finance/salaries").pipe(r(t=>t.data||[]),l(t=>this.salaries=t.map(e=>h(o({},e),{id:e.id.toString(),date:new Date(e.date),amount:this.parseAmount(e.amount)}))),g(1))),this.salariesCache$}addSalary(t){return this.apiService.post("/finance/salaries",t).pipe(r(e=>e.data),l(e=>{this.salaries.push(h(o({},e),{id:e.id.toString(),date:new Date(e.date)})),this.salariesCache$=null}))}updateSalary(t,e){return this.apiService.put(`/finance/salaries/${t}`,e).pipe(r(s=>s.data),l(s=>{let i=this.salaries.findIndex(n=>n.id===t);i!==-1&&(this.salaries[i]=h(o({},s),{id:s.id.toString(),date:new Date(s.date)})),this.salariesCache$=null}))}deleteSalary(t){return this.apiService.delete(`/finance/salaries/${t}`).pipe(r(e=>e.success),l(()=>{let e=this.salaries.findIndex(s=>s.id===t);e!==-1&&this.salaries.splice(e,1),this.salariesCache$=null}))}getTotalIncome(){return this.salaries.reduce((t,e)=>t+e.amount,0)}getTotalExpensesForMonth(t,e){return this.expenses.filter(s=>{let i=new Date(s.date);return i.getFullYear()===t&&i.getMonth()===e}).reduce((s,i)=>s+this.parseAmount(i.amount),0)}getMonthlySalary(){let t=new Date;return this.getSalaryForMonth(t.getFullYear(),t.getMonth())}getSalaryForMonth(t,e){let i=this.salaries.filter(a=>{let d=new Date(a.date);return a.period==="monthly"&&d.getFullYear()===t&&d.getMonth()===e}).reduce((a,d)=>a+this.parseAmount(d.amount),0),u=this.salaries.filter(a=>{let d=new Date(a.date);return a.period==="yearly"&&d.getFullYear()===t}).reduce((a,d)=>a+this.parseAmount(d.amount)/12,0);return i+u}getSalariesForMonth(t,e){return this.salaries.filter(s=>{let i=new Date(s.date);return s.period==="monthly"?i.getFullYear()===t&&i.getMonth()===e:s.period==="yearly"&&i.getFullYear()===t})}getMonthlyBudget(){return this.budgets.filter(e=>e.period==="monthly").reduce((e,s)=>e+this.parseAmount(s.limit),0)}getRemainingBudget(t,e){let s=t!==void 0&&e!==void 0?{year:t,month:e}:{year:new Date().getFullYear(),month:new Date().getMonth()},i=this.getTotalExpensesForMonth(s.year,s.month);return this.getMonthlyBudget()-i}getCumulativeBalanceBeforeMonth(t,e){let s=0,i=new Set;this.salaries.forEach(u=>{let a=new Date(u.date),d=`${a.getFullYear()}-${a.getMonth()}`;(a.getFullYear()<t||a.getFullYear()===t&&a.getMonth()<e)&&i.add(d)}),this.expenses.forEach(u=>{let a=new Date(u.date),d=`${a.getFullYear()}-${a.getMonth()}`;(a.getFullYear()<t||a.getFullYear()===t&&a.getMonth()<e)&&i.add(d)});let n=Array.from(i).sort();for(let u of n){let[a,d]=u.split("-").map(Number),c=this.getSalaryForMonth(a,d),f=this.getTotalExpensesForMonth(a,d);s+=c-f}return s}getRemainingBalance(t,e){let s=t!==void 0&&e!==void 0?{year:t,month:e}:{year:new Date().getFullYear(),month:new Date().getMonth()},i=this.getCumulativeBalanceBeforeMonth(s.year,s.month),n=this.getSalaryForMonth(s.year,s.month),u=this.getTotalExpensesForMonth(s.year,s.month);return i+n-u}getSavingsSuggestions(t,e){let s=[],i=t!==void 0&&e!==void 0?{year:t,month:e}:{year:new Date().getFullYear(),month:new Date().getMonth()},n=this.getTotalExpensesForMonth(i.year,i.month),u=this.expenses.filter(a=>{let d=new Date(a.date);return d.getFullYear()===i.year&&d.getMonth()===i.month});return n>0&&(u.filter(c=>c.category==="food").reduce((c,f)=>c+this.parseAmount(f.amount),0)>n*.3&&s.push("Consid\xE9rez r\xE9duire les d\xE9penses alimentaires en cuisinant plus \xE0 la maison"),u.filter(c=>c.category==="leisure").reduce((c,f)=>c+this.parseAmount(f.amount),0)>n*.2&&s.push("R\xE9duisez les d\xE9penses de loisirs en cherchant des activit\xE9s gratuites")),s}getExpensesForMonth(t,e){return this.expenses.filter(s=>{let i=new Date(s.date);return i.getFullYear()===t&&i.getMonth()===e})}addSavingsGoal(t){let e="currentAmount"in t?h(o({},t),{currentAmount:t.currentAmount||0}):h(o({},t),{currentAmount:0});return this.apiService.post("/finance/savings-goals",e).pipe(r(s=>s.data),l(s=>{this.savingsGoals.push(h(o({},s),{id:s.id.toString(),deadline:s.deadline?new Date(s.deadline):void 0})),this.savingsGoalsCache$=null}))}getWalletCards(){return this.walletCards.map(t=>h(o({},t),{id:typeof t.id=="number"?t.id.toString():t.id}))}getWalletCardsObservable(){return this.walletCardsCache$||(this.walletCardsCache$=this.apiService.get("/finance/wallet-cards").pipe(r(t=>(t.data||[]).map(e=>h(o({},e),{id:typeof e.id=="number"?e.id.toString():e.id,isDefault:!!e.isDefault}))),l(t=>{this.walletCards=t}),g(1))),this.walletCardsCache$}getDefaultWalletCard(){return this.walletCards.find(e=>e.isDefault)??this.walletCards[0]??null}addWalletCard(t){return this.apiService.post("/finance/wallet-cards",{holderName:t.holderName,cardNumber:t.cardNumber,expiryDate:t.expiryDate,rib:t.rib??void 0,isDefault:t.isDefault}).pipe(r(e=>e.data),l(e=>{let s=h(o({},e),{id:typeof e.id=="number"?e.id.toString():e.id,isDefault:!!e.isDefault});this.walletCards.some(i=>String(i.id)===String(s.id))?this.walletCards=this.walletCards.map(i=>String(i.id)===String(s.id)?s:i):this.walletCards=[...this.walletCards,s],this.walletCardsCache$=null}))}updateWalletCard(t,e){return this.apiService.put(`/finance/wallet-cards/${t}`,e).pipe(r(s=>s.data),l(s=>{let i=h(o({},s),{id:typeof s.id=="number"?s.id.toString():s.id,isDefault:!!s.isDefault});this.walletCards=this.walletCards.map(n=>String(n.id)===String(t)?i:n),e.isDefault===!0&&(this.walletCards=this.walletCards.map(n=>h(o({},n),{isDefault:String(n.id)===String(t)}))),this.walletCardsCache$=null}))}deleteWalletCard(t){return this.apiService.delete(`/finance/wallet-cards/${t}`).pipe(r(e=>e.success),l(e=>{e&&(this.walletCards=this.walletCards.filter(s=>String(s.id)!==t),this.walletCardsCache$=null)}))}invalidateWalletCardsCache(){this.walletCardsCache$=null}loadAll(){this.authService.isAuthenticated()?S({expenses:this.getExpensesObservable(),budgets:this.getBudgetsObservable(),savingsGoals:this.getSavingsGoalsObservable(),salaries:this.getSalariesObservable(),categories:this.getCustomCategoriesObservable(),walletCards:this.getWalletCardsObservable()}).subscribe({error:t=>console.error("Error loading finance data:",t)}):(this.expenses=[],this.budgets=[],this.savingsGoals=[],this.salaries=[],this.customCategories=[],this.walletCards=[])}static{this.\u0275fac=function(e){return new(e||p)(m($),m(b))}}static{this.\u0275prov=x({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})();export{F as a};
