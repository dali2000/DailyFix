import{Wa as k,_a as S,d as c,g as i,k as p,l as v,n as a,q as l,t as o}from"./chunk-HBTCCMIC.js";import{a as h,b as u}from"./chunk-POLL2CVR.js";var T=(()=>{class n{constructor(t,e){this.authService=t,this.apiService=e,this.tasks=[],this.tasksSubject=new c([]),this.events=[],this.eventsCache$=null,this.authService.currentUser$.pipe(p()).subscribe(s=>{s!==null?(this.loadTasks(),this.loadEvents()):(this.tasks=[],this.tasksSubject.next([]),this.events=[],this.eventsCache$=null)})}getTasks(){return[...this.tasks]}getTasksObservable(){return this.tasksSubject.asObservable()}getTaskById(t){return this.tasks.find(e=>e.id===t)}getTaskByIdObservable(t){return this.apiService.get(`/tasks/${t}`).pipe(i(e=>e.data))}addTask(t){return this.apiService.post("/tasks",t).pipe(i(e=>e.data),a(e=>{let s=this.normalizeTask(e);this.tasks.push(s),this.tasksSubject.next([...this.tasks])}))}updateTask(t,e){return this.apiService.put(`/tasks/${t}`,e).pipe(i(s=>s.data),a(s=>{let r=this.normalizeTask(s),d=this.tasks.findIndex(g=>g.id===t);d!==-1&&(this.tasks[d]=r),this.tasksSubject.next([...this.tasks])}))}deleteTask(t){return this.apiService.delete(`/tasks/${t}`).pipe(i(e=>e.success),a(()=>{let e=this.tasks.findIndex(s=>s.id===t);e!==-1&&this.tasks.splice(e,1),this.tasksSubject.next([...this.tasks])}))}getTasksForDate(t){let e=t.toDateString();return this.tasks.filter(s=>s.dueDate&&new Date(s.dueDate).toDateString()===e)}getTasksByStatus(t){return this.apiService.get(`/tasks/status/${t}`).pipe(i(e=>e.data||[]))}updateTaskStatus(t,e){return this.updateTask(t,{status:e})}getCompletedTasksCount(){return this.tasks.filter(t=>t.completed).length}getTasksCompletedTodayCount(){let t=new Date().toDateString();return this.tasks.filter(e=>{if(e.status!=="done"&&!e.completed)return!1;let s=e.updatedAt?new Date(e.updatedAt):null;return s&&s.toDateString()===t}).length}getTotalTasksCount(){return this.tasks.length}getEvents(){return[...this.events]}getEventsObservable(){return this.eventsCache$||(this.eventsCache$=this.apiService.get("/events").pipe(i(t=>t.data||[]),a(t=>this.events=t),v(1))),this.eventsCache$}addEvent(t){return this.apiService.post("/events",t).pipe(i(e=>e.data),a(e=>{this.events.push(e),this.eventsCache$=null}))}updateEvent(t,e){return this.apiService.put(`/events/${t}`,e).pipe(i(s=>s.data),a(s=>{let r=this.events.findIndex(d=>d.id===t);r!==-1&&(this.events[r]=s),this.eventsCache$=null}))}deleteEvent(t){return this.apiService.delete(`/events/${t}`).pipe(i(e=>e.success),a(()=>{let e=this.events.findIndex(s=>s.id===t);e!==-1&&this.events.splice(e,1),this.eventsCache$=null}))}getEventsForDate(t){let e=t.toDateString();return this.events.filter(s=>new Date(s.startDate).toDateString()===e)}getEventsForDateObservable(t){let e=t.toISOString().split("T")[0];return this.apiService.get(`/events/date/${e}`).pipe(i(s=>s.data||[]))}normalizeTask(t){return u(h({},t),{id:t.id?.toString()??t.id,status:t.status||(t.completed?"done":"todo"),priority:t.priority||"medium",dueDate:t.dueDate?new Date(t.dueDate):void 0,reminder:t.reminder?new Date(t.reminder):void 0,createdAt:new Date(t.createdAt),updatedAt:t.updatedAt?new Date(t.updatedAt):new Date(t.createdAt)})}loadTasks(){if(!this.authService.isAuthenticated()){this.tasks=[],this.tasksSubject.next([]);return}this.apiService.get("/tasks").pipe(i(t=>(t.data||[]).map(e=>this.normalizeTask(e)))).subscribe({next:t=>{this.tasks=t,this.tasksSubject.next([...this.tasks])},error:t=>{console.error("Error loading tasks:",t),this.tasks=[],this.tasksSubject.next([])}})}loadEvents(){this.authService.isAuthenticated()?this.getEventsObservable().subscribe({next:t=>{this.events=t.map(e=>u(h({},e),{id:e.id.toString(),startDate:new Date(e.startDate),endDate:e.endDate?new Date(e.endDate):void 0}))},error:t=>{console.error("Error loading events:",t),this.events=[]}}):this.events=[]}static{this.\u0275fac=function(e){return new(e||n)(o(S),o(k))}}static{this.\u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{T as a};
