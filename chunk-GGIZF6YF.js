import{Wa as L,_a as $,g as r,h as D,k as f,l as c,m as g,n as p,q as S,t as m}from"./chunk-HBTCCMIC.js";import{a,b as h}from"./chunk-POLL2CVR.js";var b=(()=>{class l{constructor(t,e){this.authService=t,this.apiService=e,this.shoppingLists=[],this.householdTasks=[],this.shoppingListsCache$=null,this.householdTasksCache$=null,this.authService.currentUser$.pipe(f()).subscribe(s=>{s!==null?this.loadAll():(this.shoppingLists=[],this.householdTasks=[],this.shoppingListsCache$=null,this.householdTasksCache$=null)})}getShoppingLists(){return[...this.shoppingLists]}getShoppingListsObservable(){return this.shoppingListsCache$||(this.shoppingListsCache$=this.apiService.get("/home/shopping-lists").pipe(r(t=>t.data||[]),r(t=>t.map(e=>{let s=[];if(e.items)if(Array.isArray(e.items))s=e.items;else if(typeof e.items=="string")try{s=JSON.parse(e.items)}catch(i){console.warn("Failed to parse items as JSON:",i),s=[]}else console.warn("Items is not an array or string:",e.items),s=[];return h(a({},e),{id:e.id.toString(),createdAt:new Date(e.createdAt),items:s.map((i,n)=>h(a({},i),{id:i.id?i.id.toString():`item_${e.id}_${n}_${Date.now()}`}))})})),p(t=>this.shoppingLists=t),c(1))),this.shoppingListsCache$}getShoppingListById(t){return this.shoppingLists.find(e=>e.id===t)}getShoppingListByIdObservable(t){let e=isNaN(Number(t))?t:Number(t);return this.apiService.get(`/home/shopping-lists/${e}`).pipe(r(s=>{let i=s.data,n=[];if(i.items)if(Array.isArray(i.items))n=i.items;else if(typeof i.items=="string")try{n=JSON.parse(i.items)}catch(o){console.warn("Failed to parse items as JSON:",o),n=[]}else console.warn("Items is not an array or string:",i.items),n=[];return h(a({},i),{id:i.id.toString(),createdAt:new Date(i.createdAt),items:n.map((o,u)=>h(a({},o),{id:o.id?o.id.toString():`item_${i.id}_${u}_${Date.now()}`}))})}))}addShoppingList(t){return this.apiService.post("/home/shopping-lists",t).pipe(r(e=>{let s=e.data;return h(a({},s),{id:s.id.toString(),createdAt:new Date(s.createdAt),items:(s.items||[]).map((i,n)=>h(a({},i),{id:i.id?i.id.toString():`item_${s.id}_${n}_${Date.now()}`}))})}),p(e=>{this.shoppingLists.push(e),this.shoppingListsCache$=null}))}updateShoppingList(t,e){let s=isNaN(Number(t))?t:Number(t);return console.log("Updating shopping list:",s,e),this.apiService.put(`/home/shopping-lists/${s}`,e).pipe(r(i=>{let n=i.data,o=[];if(n.items)if(Array.isArray(n.items))o=n.items;else if(typeof n.items=="string")try{o=JSON.parse(n.items)}catch(d){console.warn("Failed to parse items as JSON:",d),o=[]}else console.warn("Items is not an array or string:",n.items),o=[];let u=h(a({},n),{id:n.id.toString(),createdAt:new Date(n.createdAt),items:o.map((d,w)=>h(a({},d),{id:d.id?d.id.toString():`item_${n.id}_${w}_${Date.now()}`}))});return console.log("Updated list received:",u),u}),p(i=>{let n=this.shoppingLists.findIndex(o=>o.id===t||o.id===i.id);n!==-1?this.shoppingLists[n]=i:this.shoppingLists.push(i),this.shoppingListsCache$=null}))}deleteShoppingList(t){return this.apiService.delete(`/home/shopping-lists/${t}`).pipe(r(e=>e.success),p(()=>{let e=this.shoppingLists.findIndex(s=>s.id===t);e!==-1&&this.shoppingLists.splice(e,1),this.shoppingListsCache$=null}))}getHouseholdTasks(){return[...this.householdTasks]}getHouseholdTasksObservable(){return this.householdTasksCache$||(this.householdTasksCache$=this.apiService.get("/home/household-tasks").pipe(r(t=>t.data||[]),p(t=>this.householdTasks=t.map(e=>h(a({},e),{id:e.id.toString(),dueDate:e.dueDate?new Date(e.dueDate):void 0,lastCompleted:e.lastCompleted?new Date(e.lastCompleted):void 0,nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0}))),c(1))),this.householdTasksCache$}getHouseholdTaskById(t){return this.householdTasks.find(e=>e.id===t)}getHouseholdTaskByIdObservable(t){return this.apiService.get(`/home/household-tasks/${t}`).pipe(r(e=>e.data))}addHouseholdTask(t){return this.apiService.post("/home/household-tasks",t).pipe(r(e=>e.data),p(e=>{this.householdTasks.push(h(a({},e),{id:e.id.toString(),dueDate:e.dueDate?new Date(e.dueDate):void 0,lastCompleted:e.lastCompleted?new Date(e.lastCompleted):void 0,nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0})),this.householdTasksCache$=null}))}updateHouseholdTask(t,e){return this.apiService.put(`/home/household-tasks/${t}`,e).pipe(r(s=>s.data),p(s=>{let i=this.householdTasks.findIndex(n=>n.id===t);i!==-1&&(this.householdTasks[i]=h(a({},s),{id:s.id.toString(),dueDate:s.dueDate?new Date(s.dueDate):void 0,lastCompleted:s.lastCompleted?new Date(s.lastCompleted):void 0,nextDueDate:s.nextDueDate?new Date(s.nextDueDate):void 0})),this.householdTasksCache$=null}))}deleteHouseholdTask(t){return this.apiService.delete(`/home/household-tasks/${t}`).pipe(r(e=>e.success),p(()=>{let e=this.householdTasks.findIndex(s=>s.id===t);e!==-1&&this.householdTasks.splice(e,1),this.householdTasksCache$=null}))}addItemToList(t,e){let s=this.shoppingLists.find(o=>o.id===t||o.id.toString()===t.toString());if(!s)return this.getShoppingListByIdObservable(t).pipe(g(o=>{let u=h(a({},e),{id:`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,purchased:e.purchased||!1}),d=[...o.items||[],u];return this.updateShoppingList(t,{items:d})}));let i=h(a({},e),{id:`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,purchased:e.purchased||!1}),n=[...s.items||[],i];return console.log("Adding item to list:",{listId:t,currentItems:s.items,newItem:i,updatedItems:n}),this.updateShoppingList(t,{items:n})}toggleItemPurchase(t,e){let s=this.shoppingLists.find(i=>i.id===t);if(s){let i=(s.items||[]).map(n=>n.id===e?h(a({},n),{purchased:!n.purchased}):n);return this.updateShoppingList(t,{items:i})}else return this.getShoppingListByIdObservable(t).pipe(r(i=>{let n=(i.items||[]).map(o=>o.id===e?h(a({},o),{purchased:!o.purchased}):o);return h(a({},i),{items:n})}),g(i=>this.updateShoppingList(t,{items:i.items})))}getUpcomingHouseholdTasks(){let t=new Date;return this.householdTasks.filter(e=>e.nextDueDate?(e.nextDueDate instanceof Date?e.nextDueDate:new Date(e.nextDueDate))>=t:!1).sort((e,s)=>{let i=e.nextDueDate instanceof Date?e.nextDueDate:e.nextDueDate?new Date(e.nextDueDate):new Date(0),n=s.nextDueDate instanceof Date?s.nextDueDate:s.nextDueDate?new Date(s.nextDueDate):new Date(0);return i.getTime()-n.getTime()})}loadAll(){this.authService.isAuthenticated()?D({shoppingLists:this.getShoppingListsObservable(),householdTasks:this.getHouseholdTasksObservable()}).subscribe({error:t=>console.error("Error loading home data:",t)}):(this.shoppingLists=[],this.householdTasks=[])}static{this.\u0275fac=function(e){return new(e||l)(m($),m(L))}}static{this.\u0275prov=S({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{b as a};
