<div class="tasks-page">
  <div class="header">
    <h1>{{ 'tasks.title' | translate }}</h1>
    <div class="actions">
      <button class="btn btn-secondary" (click)="viewMode = viewMode === 'kanban' ? 'list' : 'kanban'">
        {{ viewMode === 'kanban' ? ('ğŸ“‹ ' + ('tasks.listView' | translate)) : ('ğŸ“Š ' + ('tasks.kanbanView' | translate)) }}
      </button>
      <button type="button" class="btn btn-primary" (click)="toggleAddForm()">
        + {{ 'tasks.createTask' | translate }}
      </button>
      <button class="btn btn-secondary" (click)="navigateToCalendar()">ğŸ“… {{ 'nav.calendar' | translate }}</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (input)="applyFilters()"
        [placeholder]="'tasks.searchPlaceholder' | translate">
    </div>
    <div class="filter-controls">
      <select [(ngModel)]="filter" (change)="applyFilters()">
        <option value="all">{{ 'tasks.allStatuses' | translate }}</option>
        <option value="todo">{{ 'tasks.todo' | translate }}</option>
        <option value="in-progress">{{ 'tasks.inProgress' | translate }}</option>
        <option value="in-review">{{ 'tasks.inReview' | translate }}</option>
        <option value="done">{{ 'tasks.done' | translate }}</option>
      </select>
      <select [(ngModel)]="priorityFilter" (change)="applyFilters()">
        <option value="all">{{ 'tasks.allPriorities' | translate }}</option>
        <option value="highest">{{ 'tasks.highest' | translate }}</option>
        <option value="high">{{ 'tasks.high' | translate }}</option>
        <option value="medium">{{ 'tasks.medium' | translate }}</option>
        <option value="low">{{ 'tasks.low' | translate }}</option>
        <option value="lowest">{{ 'tasks.lowest' | translate }}</option>
      </select>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <app-modal
    *ngIf="showAddForm"
    [title]="modalTitleKey | translate"
    size="lg"
    (closeModal)="closeTaskModal()"
  >
    <form (ngSubmit)="saveTask()">
      <div class="form-group">
        <label for="task-title">{{ 'tasks.taskTitle' | translate }} *</label>
        <input id="task-title" type="text" [(ngModel)]="newTask.title" name="title" required [placeholder]="'tasks.taskTitlePlaceholder' | translate">
      </div>
      <div class="form-group">
        <label for="task-desc">{{ 'common.description' | translate }}</label>
        <textarea id="task-desc" [(ngModel)]="newTask.description" name="description" rows="4" [placeholder]="'tasks.taskDescPlaceholder' | translate"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'tasks.status' | translate }}</label>
          <select [(ngModel)]="newTask.status" name="status">
            <option value="todo">{{ 'tasks.todo' | translate }}</option>
            <option value="in-progress">{{ 'tasks.inProgress' | translate }}</option>
            <option value="in-review">{{ 'tasks.inReview' | translate }}</option>
            <option value="done">{{ 'tasks.done' | translate }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'tasks.priority' | translate }}</label>
          <select [(ngModel)]="newTask.priority" name="priority">
            <option *ngFor="let p of priorityOptions" [value]="p.value">
              {{ p.icon }} {{ p.labelKey | translate }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'tasks.assignee' | translate }}</label>
          <input type="text" [(ngModel)]="newTask.assignee" name="assignee" [placeholder]="'tasks.assigneePlaceholder' | translate">
        </div>
        <div class="form-group">
          <label>{{ 'tasks.storyPoints' | translate }}</label>
          <input type="number" [(ngModel)]="newTask.storyPoints" name="storyPoints" min="0" max="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'tasks.labels' | translate }}</label>
          <input type="text" [(ngModel)]="newTask.labels" name="labels" [placeholder]="'tasks.labelsPlaceholder' | translate">
        </div>
        <div class="form-group">
          <label>{{ 'tasks.dueDate' | translate }}</label>
          <input type="date" [(ngModel)]="newTask.dueDate" name="dueDate">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeTaskModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.save' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <!-- Kanban View -->
  <div *ngIf="viewMode === 'kanban'" class="kanban-board">
    <div 
      *ngFor="let column of statusColumns" 
      class="kanban-column"
      [attr.data-column-id]="column.id"
      (dragover)="onDragOver($event)"
      (drop)="onDrop($event, column.id)">
      <div class="column-header" [style.border-left-color]="column.color">
        <h3>{{ column.labelKey | translate }}</h3>
        <span class="task-count">{{ getTasksForStatus(column.id).length }}</span>
      </div>
      <div class="column-content">
        <div 
          *ngFor="let task of getTasksForStatus(column.id)" 
          class="task-card"
          [attr.draggable]="true"
          (dragstart)="onDragStart(task)"
          (dragend)="onDragEnd()"
          (touchstart)="onTouchStart($event, task)"
          (touchmove)="onTouchMove($event)"
          (touchend)="onTouchEnd($event)"
          (touchcancel)="onTouchCancel()"
          [class.dragging]="draggedTask?.id === task.id"
          [class.touch-dragging]="isTouchDragging && draggedTask?.id === task.id">
          <div class="task-card-header">
            <div class="task-id">{{ task.id.substring(0, 8) }}</div>
            <div class="task-actions">
              <button class="icon-btn" (click)="editTask(task)" [title]="'common.edit' | translate">âœï¸</button>
              <button class="icon-btn" (click)="deleteTask(task)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
            </div>
          </div>
          <h4 class="task-title">{{ task.title }}</h4>
          <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
          <div class="task-meta">
            <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
              {{ getPriorityLabel(task.priority) }}
            </span>
            <span *ngIf="task.storyPoints" class="story-points">âš¡ {{ task.storyPoints }}</span>
          </div>
          <div class="task-footer">
            <div class="task-labels" *ngIf="task.labels && task.labels.length > 0">
              <span *ngFor="let label of task.labels" class="label">{{ label }}</span>
            </div>
            <div class="task-assignee" *ngIf="task.assignee">
              <span class="assignee-avatar">{{ task.assignee.charAt(0).toUpperCase() }}</span>
              <span class="assignee-name">{{ task.assignee }}</span>
            </div>
            <div *ngIf="task.dueDate" class="due-date">
              ğŸ“… {{ task.dueDate | date:'shortDate' }}
            </div>
          </div>
        </div>
        <div *ngIf="getTasksForStatus(column.id).length === 0" class="empty-column">
          {{ 'tasks.noTask' | translate }}
        </div>
      </div>
    </div>
  </div>

  <!-- List View -->
  <div *ngIf="viewMode === 'list'" class="list-view">
    <table class="tasks-table">
      <thead>
        <tr>
          <th>{{ 'tasks.id' | translate }}</th>
          <th>{{ 'common.title' | translate }}</th>
          <th>{{ 'tasks.status' | translate }}</th>
          <th>{{ 'tasks.priority' | translate }}</th>
          <th>{{ 'tasks.assignee' | translate }}</th>
          <th>{{ 'tasks.labels' | translate }}</th>
          <th>{{ 'tasks.dueDate' | translate }}</th>
          <th>{{ 'tasks.actions' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of filteredTasks" class="table-row">
          <td class="task-id-cell">{{ task.id.substring(0, 8) }}</td>
          <td class="task-title-cell">
            <strong>{{ task.title }}</strong>
            <small *ngIf="task.description">{{ task.description }}</small>
          </td>
          <td>
            <span class="status-badge" [style.background-color]="getStatusColor(task.status)">
              {{ getStatusLabel(task.status) }}
            </span>
          </td>
          <td>
            <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
              {{ getPriorityLabel(task.priority) }}
            </span>
          </td>
          <td>
            <span *ngIf="task.assignee" class="assignee">
              <span class="assignee-avatar">{{ task.assignee.charAt(0).toUpperCase() }}</span>
              {{ task.assignee }}
            </span>
            <span *ngIf="!task.assignee" class="no-assignee">{{ 'tasks.noAssignee' | translate }}</span>
          </td>
          <td>
            <span *ngFor="let label of task.labels" class="label">{{ label }}</span>
            <span *ngIf="!task.labels || task.labels.length === 0">â€”</span>
          </td>
          <td>
            <span *ngIf="task.dueDate">{{ task.dueDate | date:'shortDate' }}</span>
            <span *ngIf="!task.dueDate">â€”</span>
          </td>
          <td class="actions-cell">
            <button class="icon-btn" (click)="editTask(task)" [title]="'common.edit' | translate">âœï¸</button>
            <button class="icon-btn" (click)="deleteTask(task)" [title]="'common.delete' | translate">ğŸ—‘ï¸</button>
          </td>
        </tr>
        <tr *ngIf="filteredTasks.length === 0">
          <td colspan="8" class="empty-state">{{ 'tasks.noTaskFound' | translate }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
