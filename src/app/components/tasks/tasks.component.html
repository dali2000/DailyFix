<div class="tasks-page">
  <div class="header">
    <h1>Gestion des TÃ¢ches</h1>
    <div class="actions">
      <button class="btn btn-secondary" (click)="viewMode = viewMode === 'kanban' ? 'list' : 'kanban'">
        {{ viewMode === 'kanban' ? 'ğŸ“‹ Liste' : 'ğŸ“Š Kanban' }}
      </button>
      <button type="button" class="btn btn-primary" (click)="toggleAddForm()">
        + CrÃ©er une tÃ¢che
      </button>
      <button class="btn btn-secondary" (click)="navigateToCalendar()">ğŸ“… Calendrier</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (input)="applyFilters()"
        placeholder="Rechercher des tÃ¢ches...">
    </div>
    <div class="filter-controls">
      <select [(ngModel)]="filter" (change)="applyFilters()">
        <option value="all">Tous les statuts</option>
        <option value="todo">Ã€ faire</option>
        <option value="in-progress">En cours</option>
        <option value="in-review">En rÃ©vision</option>
        <option value="done">TerminÃ©</option>
      </select>
      <select [(ngModel)]="priorityFilter" (change)="applyFilters()">
        <option value="all">Toutes les prioritÃ©s</option>
        <option value="highest">TrÃ¨s haute</option>
        <option value="high">Haute</option>
        <option value="medium">Moyenne</option>
        <option value="low">Basse</option>
        <option value="lowest">TrÃ¨s basse</option>
      </select>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <app-modal
    *ngIf="showAddForm"
    [title]="editingTask ? 'Modifier la tÃ¢che' : 'CrÃ©er une nouvelle tÃ¢che'"
    size="lg"
    (closeModal)="closeTaskModal()"
  >
    <form (ngSubmit)="saveTask()">
      <div class="form-group">
        <label for="task-title">Titre *</label>
        <input id="task-title" type="text" [(ngModel)]="newTask.title" name="title" required placeholder="RÃ©sumÃ© de la tÃ¢che">
      </div>
      <div class="form-group">
        <label for="task-desc">Description</label>
        <textarea id="task-desc" [(ngModel)]="newTask.description" name="description" rows="4" placeholder="DÃ©crivez la tÃ¢che..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Statut</label>
          <select [(ngModel)]="newTask.status" name="status">
            <option value="todo">Ã€ faire</option>
            <option value="in-progress">En cours</option>
            <option value="in-review">En rÃ©vision</option>
            <option value="done">TerminÃ©</option>
          </select>
        </div>
        <div class="form-group">
          <label>PrioritÃ©</label>
          <select [(ngModel)]="newTask.priority" name="priority">
            <option *ngFor="let p of priorityOptions" [value]="p.value">
              {{ p.icon }} {{ p.label }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>AssignÃ© Ã </label>
          <input type="text" [(ngModel)]="newTask.assignee" name="assignee" placeholder="Nom">
        </div>
        <div class="form-group">
          <label>Story Points</label>
          <input type="number" [(ngModel)]="newTask.storyPoints" name="storyPoints" min="0" max="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Labels (sÃ©parÃ©s par des virgules)</label>
          <input type="text" [(ngModel)]="newTask.labels" name="labels" placeholder="bug, feature, urgent">
        </div>
        <div class="form-group">
          <label>Date d'Ã©chÃ©ance</label>
          <input type="date" [(ngModel)]="newTask.dueDate" name="dueDate">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeTaskModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </app-modal>

  <!-- Kanban View -->
  <div *ngIf="viewMode === 'kanban'" class="kanban-board">
    <div 
      *ngFor="let column of statusColumns" 
      class="kanban-column"
      (dragover)="onDragOver($event)"
      (drop)="onDrop($event, column.id)">
      <div class="column-header" [style.border-left-color]="column.color">
        <h3>{{ column.label }}</h3>
        <span class="task-count">{{ getTasksForStatus(column.id).length }}</span>
      </div>
      <div class="column-content">
        <div 
          *ngFor="let task of getTasksForStatus(column.id)" 
          class="task-card"
          [attr.draggable]="true"
          (dragstart)="onDragStart(task)"
          (dragend)="onDragEnd()"
          [class.dragging]="draggedTask?.id === task.id">
          <div class="task-card-header">
            <div class="task-id">{{ task.id.substring(0, 8) }}</div>
            <div class="task-actions">
              <button class="icon-btn" (click)="editTask(task)" title="Modifier">âœï¸</button>
              <button class="icon-btn" (click)="deleteTask(task)" title="Supprimer">ğŸ—‘ï¸</button>
            </div>
          </div>
          <h4 class="task-title">{{ task.title }}</h4>
          <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
          <div class="task-meta">
            <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
              {{ getPriorityLabel(task.priority) }}
            </span>
            <span *ngIf="task.storyPoints" class="story-points">âš¡ {{ task.storyPoints }}</span>
          </div>
          <div class="task-footer">
            <div class="task-labels" *ngIf="task.labels && task.labels.length > 0">
              <span *ngFor="let label of task.labels" class="label">{{ label }}</span>
            </div>
            <div class="task-assignee" *ngIf="task.assignee">
              <span class="assignee-avatar">{{ task.assignee.charAt(0).toUpperCase() }}</span>
              <span class="assignee-name">{{ task.assignee }}</span>
            </div>
            <div *ngIf="task.dueDate" class="due-date">
              ğŸ“… {{ task.dueDate | date:'shortDate' }}
            </div>
          </div>
        </div>
        <div *ngIf="getTasksForStatus(column.id).length === 0" class="empty-column">
          Aucune tÃ¢che
        </div>
      </div>
    </div>
  </div>

  <!-- List View -->
  <div *ngIf="viewMode === 'list'" class="list-view">
    <table class="tasks-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Titre</th>
          <th>Statut</th>
          <th>PrioritÃ©</th>
          <th>AssignÃ©</th>
          <th>Labels</th>
          <th>Date d'Ã©chÃ©ance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of filteredTasks" class="table-row">
          <td class="task-id-cell">{{ task.id.substring(0, 8) }}</td>
          <td class="task-title-cell">
            <strong>{{ task.title }}</strong>
            <small *ngIf="task.description">{{ task.description }}</small>
          </td>
          <td>
            <span class="status-badge" [style.background-color]="getStatusColor(task.status)">
              {{ getStatusLabel(task.status) }}
            </span>
          </td>
          <td>
            <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
              {{ getPriorityLabel(task.priority) }}
            </span>
          </td>
          <td>
            <span *ngIf="task.assignee" class="assignee">
              <span class="assignee-avatar">{{ task.assignee.charAt(0).toUpperCase() }}</span>
              {{ task.assignee }}
            </span>
            <span *ngIf="!task.assignee" class="no-assignee">â€”</span>
          </td>
          <td>
            <span *ngFor="let label of task.labels" class="label">{{ label }}</span>
            <span *ngIf="!task.labels || task.labels.length === 0">â€”</span>
          </td>
          <td>
            <span *ngIf="task.dueDate">{{ task.dueDate | date:'shortDate' }}</span>
            <span *ngIf="!task.dueDate">â€”</span>
          </td>
          <td class="actions-cell">
            <button class="icon-btn" (click)="editTask(task)" title="Modifier">âœï¸</button>
            <button class="icon-btn" (click)="deleteTask(task)" title="Supprimer">ğŸ—‘ï¸</button>
          </td>
        </tr>
        <tr *ngIf="filteredTasks.length === 0">
          <td colspan="8" class="empty-state">Aucune tÃ¢che trouvÃ©e</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
