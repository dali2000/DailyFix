<div class="home-org-page">
  <h1>{{ 'homeOrg.title' | translate }}</h1>

  <div *ngIf="errorMessage" class="alert alert-error">
    <span>{{ errorMessage }}</span>
    <button type="button" class="alert-close" (click)="errorMessage = null" [attr.aria-label]="'common.close' | translate">×</button>
  </div>

  <div class="tabs">
    <button [class.active]="activeTab === 'shopping'" (click)="activeTab = 'shopping'">{{ 'homeOrg.shoppingLists' | translate }}</button>
    <button [class.active]="activeTab === 'tasks'" (click)="activeTab = 'tasks'">{{ 'homeOrg.householdTasks' | translate }}</button>
  </div>

  <!-- Shopping Lists Tab -->
  <div *ngIf="activeTab === 'shopping'" class="tab-content">
    <div class="section-header">
      <h2>{{ 'homeOrg.shoppingLists' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showShoppingForm = true">+ {{ 'homeOrg.newList' | translate }}</button>
    </div>

    <div class="shopping-lists-container">
      <div class="lists-sidebar">
        <h3>{{ 'homeOrg.myLists' | translate }}</h3>
        <div *ngFor="let list of shoppingLists" 
             class="list-item" 
             [class.active]="selectedList?.id === list.id"
             (click)="selectList(list)">
          <span>{{ list.name }}</span>
          <span class="item-count">{{ (list.items || []).length }} {{ 'homeOrg.articles' | translate }}</span>
        </div>
        <div *ngIf="shoppingLists.length === 0" class="empty-state">
          {{ 'homeOrg.noList' | translate }}
        </div>
      </div>

      <div *ngIf="selectedList" class="list-details">
        <div class="list-header">
          <h3>{{ selectedList.name }}</h3>
          <button class="btn btn-danger btn-small" (click)="deleteShoppingList(selectedList.id)">{{ 'common.delete' | translate }}</button>
        </div>

        <div class="add-item-form">
          <h4>{{ 'homeOrg.addArticle' | translate }}</h4>
          <form (ngSubmit)="addItemToList($event)">
            <div class="form-row">
              <input type="text" [(ngModel)]="newItem.name" name="itemName" [placeholder]="'homeOrg.articleNamePlaceholder' | translate" required>
              <input type="text" [(ngModel)]="newItem.quantity" name="quantity" [placeholder]="'homeOrg.quantity' | translate">
              <select [(ngModel)]="newItem.category" name="category">
                <option value="">{{ 'common.category' | translate }}</option>
                <option value="fruits">{{ 'homeOrg.fruitsVeg' | translate }}</option>
                <option value="dairy">{{ 'homeOrg.dairy' | translate }}</option>
                <option value="meat">{{ 'homeOrg.meatFish' | translate }}</option>
                <option value="bakery">{{ 'homeOrg.bakery' | translate }}</option>
                <option value="beverages">{{ 'homeOrg.beverages' | translate }}</option>
                <option value="other">{{ 'finance.other' | translate }}</option>
              </select>
              <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
            </div>
          </form>
        </div>

        <div class="items-list">
          <div *ngFor="let item of (selectedList.items || [])" class="item-card" [class.purchased]="item.purchased">
            <div class="item-checkbox">
              <input type="checkbox" [checked]="item.purchased" 
                     (change)="toggleItemPurchase(selectedList.id, item.id)"
                     id="item-{{item.id}}">
              <label for="item-{{item.id}}" class="checkbox-label"></label>
            </div>
            <div class="item-content">
              <div class="item-main">
                <span class="item-name">{{ item.name }}</span>
                <span *ngIf="item.quantity" class="item-quantity">x{{ item.quantity }}</span>
              </div>
              <div *ngIf="item.category" class="item-category">{{ getCategoryLabel(item.category) }}</div>
            </div>
          </div>
          <div *ngIf="!selectedList.items || selectedList.items.length === 0" class="empty-state">
            Aucun article. Ajoutez-en !
          </div>
        </div>
      </div>

      <div *ngIf="!selectedList && shoppingLists.length > 0" class="no-selection">
        <p>{{ 'common.noData' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Household Tasks Tab -->
  <div *ngIf="activeTab === 'tasks'" class="tab-content">
    <div class="section-header">
      <h2>Tâches ménagères</h2>
      <button type="button" class="btn btn-primary" (click)="showTaskForm = true">+ Nouvelle tâche</button>
    </div>

    <div class="upcoming-tasks-section">
      <h3>Prochaines tâches</h3>
      <div class="tasks-list">
        <div *ngFor="let task of getUpcomingTasks()" class="task-card">
          <input type="checkbox" [checked]="task.completed" (change)="toggleTaskComplete(task)">
          <div class="task-info">
            <h4>{{ task.name }}</h4>
            <p *ngIf="task.description">{{ task.description }}</p>
            <div class="task-meta">
              <span class="frequency">{{ task.frequency }}</span>
              <span *ngIf="task.nextDueDate" class="due-date">
                Prochaine: {{ formatDate(task.nextDueDate) }}
              </span>
            </div>
          </div>
          <button class="btn btn-small btn-danger" (click)="deleteHouseholdTask(task.id)">{{ 'common.delete' | translate }}</button>
        </div>
      </div>
    </div>

    <div class="all-tasks-section">
      <h3>{{ 'homeOrg.householdTasks' | translate }}</h3>
      <div class="tasks-list">
        <div *ngFor="let task of householdTasks" class="task-card" [class.completed]="task.completed">
          <input type="checkbox" [checked]="task.completed" (change)="toggleTaskComplete(task)">
          <div class="task-info">
            <h4>{{ task.name }}</h4>
            <p *ngIf="task.description">{{ task.description }}</p>
            <div class="task-meta">
              <span class="frequency">{{ task.frequency }}</span>
              <span *ngIf="task.lastCompleted" class="last-completed">
                Dernière: {{ formatDate(task.lastCompleted) }}
              </span>
            </div>
          </div>
          <button class="btn btn-small btn-danger" (click)="deleteHouseholdTask(task.id)">{{ 'common.delete' | translate }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bouton idées repas / dîner + fenêtre chat (même affichage que Santé) -->
  <div class="quick-actions">
    <button type="button" class="quick-action-btn quick-action-meal" (click)="houseChatOpen = !houseChatOpen" [class.is-open]="houseChatOpen" [title]="'homeOrg.assistant' | translate" aria-label="Idées repas">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8h2.5V14H21V6h-5z"/>
      </svg>
    </button>
  </div>

  <div *ngIf="houseChatOpen" class="chatbot-panel chatbot-panel-floating">
    <div class="chatbot-panel-header">
      <h3>{{ 'homeOrg.assistantTitle' | translate }}</h3>
      <button type="button" class="chatbot-close" (click)="houseChatOpen = false" aria-label="Fermer">×</button>
    </div>
    <div *ngIf="!geminiAvailable" class="chatbot-unavailable">
      <p>{{ 'homeOrg.assistantUnavailable' | translate }}</p>
      <small>{{ 'homeOrg.assistantUnavailableHint' | translate }}</small>
    </div>
    <div *ngIf="geminiAvailable" class="chatbot-body">
      <div class="chatbot-messages">
        <div *ngFor="let msg of houseChatMessages" class="chat-row" [class.chat-row-user]="msg.role === 'user'" [class.chat-row-bot]="msg.role === 'model'">
          <div class="chat-bubble" [class.chat-bubble-user]="msg.role === 'user'" [class.chat-bubble-bot]="msg.role === 'model'">
            <span class="chat-bubble-label">{{ msg.role === 'user' ? ('health.you' | translate) : 'Gemini' }}</span>
            <div class="chat-bubble-text" [innerText]="msg.text"></div>
          </div>
        </div>
        <div *ngIf="houseChatLoading" class="chat-row chat-row-bot">
          <div class="chat-bubble chat-bubble-bot chat-bubble-loading">
            <span class="chat-bubble-label">Gemini</span>
            <div class="chat-bubble-text">{{ 'common.loading' | translate }}...</div>
          </div>
        </div>
      </div>
      <p *ngIf="houseChatError" class="chat-error">{{ houseChatError | translate }}</p>
      <form class="chatbot-form" (ngSubmit)="sendHouseholdChatMessage()">
        <input type="text" [(ngModel)]="houseChatInput" name="houseChatInput" [placeholder]="'homeOrg.assistantPlaceholder' | translate" [disabled]="houseChatLoading" class="chat-input">
        <button type="submit" class="btn btn-primary chat-send" [disabled]="houseChatLoading || !houseChatInput.trim()">
          {{ 'health.send' | translate }}
        </button>
      </form>
    </div>
  </div>

  <app-modal *ngIf="showShoppingForm" [title]="'homeOrg.newList' | translate" size="sm" (closeModal)="closeShoppingModal()">
    <form (ngSubmit)="createShoppingList()">
      <div class="form-group">
        <label>{{ 'common.name' | translate }} *</label>
        <input type="text" [(ngModel)]="newListName" name="listName" required>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeShoppingModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.create' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <app-modal *ngIf="showTaskForm" [title]="'homeOrg.newHouseholdTask' | translate" size="md" (closeModal)="closeTaskModal()">
    <form (ngSubmit)="addHouseholdTask()">
      <div class="form-group">
        <label>{{ 'homeOrg.taskNamePlaceholder' | translate }} *</label>
        <input type="text" [(ngModel)]="newTask.name" name="name" required>
      </div>
      <div class="form-group">
        <label>{{ 'common.description' | translate }}</label>
        <textarea [(ngModel)]="newTask.description" name="description" rows="2"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'common.period' | translate }}</label>
          <select [(ngModel)]="newTask.frequency" name="frequency">
            <option value="daily">Quotidienne</option>
            <option value="weekly">{{ 'common.weekly' | translate }}</option>
            <option value="monthly">{{ 'common.monthly' | translate }}</option>
            <option value="one-time">Unique</option>
          </select>
        </div>
        <div class="form-group" *ngIf="newTask.frequency === 'one-time'">
          <label>{{ 'tasks.dueDate' | translate }}</label>
          <input type="date" [(ngModel)]="newTask.dueDate" name="dueDate">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeTaskModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.create' | translate }}</button>
      </div>
    </form>
  </app-modal>
</div>

