<div class="settings-page">
  <div class="settings-container">
    <header class="settings-header">
      <h1 class="settings-title">{{ 'settings.title' | translate }}</h1>
      <p class="settings-desc">{{ 'settings.profileDesc' | translate }}</p>
    </header>

    <!-- Section Profil -->
    <section class="settings-section profile-section">
      <h2 class="section-heading">{{ 'settings.profile' | translate }}</h2>
      <p class="section-desc">{{ 'settings.profileDesc' | translate }}</p>

      <div class="profile-card">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" [class.has-photo]="currentUser?.profilePhoto">
            <img *ngIf="currentUser?.profilePhoto" [src]="currentUser.profilePhoto" alt="" class="avatar-img">
            <span *ngIf="!currentUser?.profilePhoto" class="avatar-initials">{{ userInitials }}</span>
          </div>
          <input
            type="file"
            #photoInput
            accept="image/*"
            (change)="onPhotoSelected($event)"
            class="profile-photo-input"
            [attr.aria-label]="'settings.changePhoto' | translate">
          <button type="button" class="btn btn-secondary btn-change-photo" (click)="photoInput.click()" [disabled]="profilePhotoSaving">
            {{ profilePhotoSaving ? ('common.loading' | translate) : ('settings.changePhoto' | translate) }}
          </button>
          <p *ngIf="profilePhotoError" class="profile-photo-error">{{ profilePhotoError }}</p>
        </div>

        <div class="profile-fields">
          <div class="form-group">
            <label for="profile-fullName">{{ 'settings.fullNameLabel' | translate }}</label>
            <input
              id="profile-fullName"
              type="text"
              class="form-input"
              [(ngModel)]="profileFullName"
              [placeholder]="'settings.fullNameLabel' | translate"
              minlength="2">
          </div>
          <div class="form-group">
            <label>{{ 'common.email' | translate }}</label>
            <p class="profile-email-readonly">{{ currentUser?.email || '‚Äî' }}</p>
            <span class="profile-email-hint">{{ 'settings.emailNotEditable' | translate }}</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="profile-height">{{ 'settings.heightLabel' | translate }}</label>
              <input id="profile-height" type="number" class="form-input" [(ngModel)]="profileHeight" min="50" max="250" step="0.1" placeholder="170">
              <small class="form-hint">{{ 'settings.heightHint' | translate }}</small>
            </div>
            <div class="form-group">
              <label for="profile-weight">{{ 'settings.weightLabel' | translate }}</label>
              <input id="profile-weight" type="number" class="form-input" [(ngModel)]="profileWeight" min="20" max="300" step="0.1" placeholder="70">
              <small class="form-hint">{{ 'settings.weightHint' | translate }}</small>
            </div>
          </div>
          <div class="form-group">
            <label for="profile-gender">{{ 'settings.genderLabel' | translate }}</label>
            <select id="profile-gender" class="form-input" [(ngModel)]="profileGender">
              <option value="">{{ 'settings.genderPlaceholder' | translate }}</option>
              <option value="male">{{ 'settings.genderMale' | translate }}</option>
              <option value="female">{{ 'settings.genderFemale' | translate }}</option>
            </select>
            <small class="form-hint">{{ 'settings.healthProfileHint' | translate }}</small>
          </div>
          <button type="button" class="btn btn-primary" (click)="saveProfile()" [disabled]="profileSaving">
            {{ profileSaving ? ('common.loading' | translate) : ('settings.saveProfile' | translate) }}
          </button>
        </div>
      </div>
    </section>

    <!-- Section Apparence -->
    <section class="settings-section section-appearance">
      <h2 class="section-heading">{{ 'settings.appearance' | translate }}</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'settings.theme' | translate }}</h3>
          <p>{{ 'settings.themeDesc' | translate }}</p>
        </div>
        <div class="setting-control">
          <div class="theme-toggle">
            <button 
              class="theme-option" 
              [class.active]="currentTheme === 'light'"
              (click)="setTheme('light')"
              [attr.aria-label]="'settings.themeLight' | translate">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <span>{{ 'settings.themeLight' | translate }}</span>
            </button>
            <button 
              class="theme-option" 
              [class.active]="currentTheme === 'dark'"
              (click)="setTheme('dark')"
              [attr.aria-label]="'settings.themeDark' | translate">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
              <span>{{ 'settings.themeDark' | translate }}</span>
            </button>
            <button 
              class="theme-option" 
              [class.active]="currentTheme === 'blue'"
              (click)="setTheme('blue')"
              aria-label="Bleu">
              <span style="width: 12px; height: 12px; border-radius: 999px; background:#2563eb;"></span>
              <span>{{ 'settings.themeBlue' | translate }}</span>
            </button>
            <button 
              class="theme-option" 
              [class.active]="currentTheme === 'forest'"
              (click)="setTheme('forest')"
              aria-label="For√™t">
              <span style="width: 12px; height: 12px; border-radius: 999px; background:#15803d;"></span>
              <span>{{ 'settings.themeForest' | translate }}</span>
            </button>
            <button 
              class="theme-option" 
              [class.active]="currentTheme === 'purple'"
              (click)="setTheme('purple')"
              aria-label="Violet">
              <span style="width: 12px; height: 12px; border-radius: 999px; background:#7c3aed;"></span>
              <span>{{ 'settings.themePurple' | translate }}</span>
            </button>
          </div>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'settings.language' | translate }}</h3>
          <p>{{ 'settings.languageDesc' | translate }}</p>
        </div>
        <div class="setting-control">
          <select
            id="locale-select"
            class="currency-select"
            [(ngModel)]="selectedLocale"
            (ngModelChange)="onLocaleChange($event)"
          >
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.label }}
            </option>
          </select>
        </div>
      </div>
    </section>

    <!-- Section Mes cat√©gories personnelles (d√©penses) -->
    <section class="settings-section custom-categories-section" [attr.aria-label]="'finance.myCategories' | translate">
      <h2 class="section-heading"><span class="section-emoji" aria-hidden="true">üè∑Ô∏è</span> {{ 'finance.myCategories' | translate }}</h2>
      <p class="section-desc">{{ 'finance.myCategoriesDesc' | translate }}</p>
      <div class="custom-categories-add">
        <input type="text" [(ngModel)]="categoryToAdd" [placeholder]="'finance.newCategoryPlaceholder' | translate" (keydown.enter)="$event.preventDefault(); addCustomCategory()">
        <button type="button" class="btn btn-primary" (click)="addCustomCategory()" [disabled]="!categoryToAdd.trim()">+ {{ 'finance.addCategoryButton' | translate }}</button>
      </div>
      <ul class="custom-categories-list" *ngIf="customCategoryList.length > 0">
        <li *ngFor="let cat of customCategoryList" class="custom-category-item">
          <span class="custom-category-icon">{{ getCategoryIcon(cat.name) }}</span>
          <span class="custom-category-name">{{ cat.name }}</span>
          <button type="button" class="btn-icon btn-icon-danger" (click)="removeCustomCategory(cat.id)" [attr.aria-label]="'common.delete' | translate" [title]="'finance.removeCategory' | translate">√ó</button>
        </li>
      </ul>
      <p *ngIf="customCategoryList.length === 0" class="custom-categories-empty">{{ 'finance.noCustomCategories' | translate }}</p>
    </section>

    <!-- Section Portefeuille -->
    <section class="settings-section section-wallet">
      <h2 class="section-heading">{{ 'settings.wallet' | translate }}</h2>

      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'settings.currency' | translate }}</h3>
          <p>{{ 'settings.currencyDesc' | translate }}</p>
        </div>
        <div class="setting-control">
          <select
            id="currency-select"
            class="currency-select"
            [(ngModel)]="selectedCurrencyCode"
            (ngModelChange)="onCurrencyChange($event)"
          >
            <option *ngFor="let c of currencies" [value]="c.code">
              {{ c.label }} ({{ c.symbol }})
            </option>
          </select>
        </div>
      </div>

      <div class="setting-item wallet-cards-item">
        <div class="setting-info">
          <h3>{{ 'settings.myCards' | translate }}</h3>
          <p>{{ 'settings.myCardsDesc' | translate }}</p>
        </div>
        <div class="setting-control wallet-cards-control">
          <button type="button" class="btn btn-primary" (click)="openAddCardModal()">
            + {{ 'settings.addCard' | translate }}
          </button>
        </div>
      </div>
      <ul class="wallet-cards-list" *ngIf="walletCards.length > 0">
        <li *ngFor="let card of walletCards" class="wallet-card-item">
          <div class="wallet-card-preview">
            <span class="wallet-card-title">{{ card.name || card.holderName }}</span>
            <span class="wallet-card-holder" *ngIf="card.name">{{ card.holderName }}</span>
            <span class="wallet-card-number">{{ maskCardNumber(card.cardNumber) }}</span>
            <span class="wallet-card-meta">
              <span class="wallet-card-expiry">{{ card.expiryDate }}</span>
              <span class="wallet-card-currency" *ngIf="card.currency">{{ card.currency }}</span>
            </span>
            <span *ngIf="card.isDefault" class="wallet-card-badge">{{ 'settings.defaultCard' | translate }}</span>
          </div>
          <div class="wallet-card-actions">
            <button type="button" class="btn btn-small btn-secondary" (click)="openEditCardModal(card)">
              {{ 'settings.editCard' | translate }}
            </button>
            <button type="button" class="btn btn-small btn-secondary" *ngIf="!card.isDefault" (click)="setDefaultCard(card)">
              {{ 'settings.setDefault' | translate }}
            </button>
            <button type="button" class="btn btn-small btn-icon-danger" (click)="deleteWalletCard(card)" [attr.aria-label]="'common.delete' | translate">√ó</button>
          </div>
        </li>
      </ul>
      <p *ngIf="walletCards.length === 0" class="wallet-cards-empty">{{ 'settings.noCards' | translate }}</p>
    </section>

    <!-- Add card modal -->
    <app-modal *ngIf="showAddCardModal" [title]="'settings.addCard' | translate" size="sm" (closeModal)="closeAddCardModal()">
      <form (ngSubmit)="addWalletCard()">
        <div class="form-group">
          <label for="card-name">{{ 'settings.cardName' | translate }}</label>
          <input id="card-name" type="text" [(ngModel)]="newCard.name" name="name" [placeholder]="'settings.cardNamePlaceholder' | translate">
        </div>
        <div class="form-group">
          <label for="card-holder">{{ 'settings.cardHolder' | translate }} *</label>
          <input id="card-holder" type="text" [(ngModel)]="newCard.holderName" name="holderName" [placeholder]="'settings.cardHolderPlaceholder' | translate" required>
        </div>
        <div class="form-group">
          <label for="card-number">{{ 'settings.cardNumber' | translate }} *</label>
          <input id="card-number" type="text" [(ngModel)]="newCard.cardNumber" name="cardNumber" [placeholder]="'settings.cardNumberPlaceholder' | translate" required>
        </div>
        <div class="form-group">
          <label for="card-expiry">{{ 'settings.cardExpiry' | translate }} *</label>
          <input id="card-expiry" type="text" [(ngModel)]="newCard.expiryDate" name="expiryDate" placeholder="MM/YY" required>
        </div>
        <div class="form-group">
          <label for="card-rib">{{ 'settings.cardRib' | translate }}</label>
          <input id="card-rib" type="text" [(ngModel)]="newCard.rib" name="rib" [placeholder]="'settings.cardRibPlaceholder' | translate">
        </div>
        <div class="form-group">
          <label for="card-currency">{{ 'settings.cardCurrency' | translate }}</label>
          <select id="card-currency" class="form-input" [(ngModel)]="newCard.currency" name="currency">
            <option *ngFor="let c of currencies" [value]="c.code">{{ c.label }} ({{ c.symbol }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'settings.cardColor' | translate }}</label>
          <div class="card-color-picker" role="group" [attr.aria-label]="'settings.cardColor' | translate">
            <button type="button" *ngFor="let opt of cardColorOptions" class="card-color-swatch" [style.background]="opt.gradient" [class.selected]="newCard.color === opt.key" (click)="newCard.color = opt.key" [attr.aria-pressed]="newCard.color === opt.key" [attr.title]="opt.key"></button>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeAddCardModal()">{{ 'common.cancel' | translate }}</button>
          <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
        </div>
      </form>
    </app-modal>

    <!-- Edit card modal -->
    <app-modal *ngIf="showEditCardModal && editCard" [title]="'settings.editCard' | translate" size="sm" (closeModal)="closeEditCardModal()">
      <form (ngSubmit)="saveEditCard()">
        <div class="form-group">
          <label for="edit-card-name">{{ 'settings.cardName' | translate }}</label>
          <input id="edit-card-name" type="text" [(ngModel)]="editCardForm.name" name="editName" [placeholder]="'settings.cardNamePlaceholder' | translate">
        </div>
        <div class="form-group">
          <label for="edit-card-holder">{{ 'settings.cardHolder' | translate }} *</label>
          <input id="edit-card-holder" type="text" [(ngModel)]="editCardForm.holderName" name="editHolderName" [placeholder]="'settings.cardHolderPlaceholder' | translate" required>
        </div>
        <div class="form-group">
          <label for="edit-card-number">{{ 'settings.cardNumber' | translate }} *</label>
          <input id="edit-card-number" type="text" [(ngModel)]="editCardForm.cardNumber" name="editCardNumber" [placeholder]="'settings.cardNumberPlaceholder' | translate" required>
        </div>
        <div class="form-group">
          <label for="edit-card-expiry">{{ 'settings.cardExpiry' | translate }} *</label>
          <input id="edit-card-expiry" type="text" [(ngModel)]="editCardForm.expiryDate" name="editExpiryDate" placeholder="MM/YY" required>
        </div>
        <div class="form-group">
          <label for="edit-card-rib">{{ 'settings.cardRib' | translate }}</label>
          <input id="edit-card-rib" type="text" [(ngModel)]="editCardForm.rib" name="editRib" [placeholder]="'settings.cardRibPlaceholder' | translate">
        </div>
        <div class="form-group">
          <label for="edit-card-currency">{{ 'settings.cardCurrency' | translate }}</label>
          <select id="edit-card-currency" class="form-input" [(ngModel)]="editCardForm.currency" name="editCurrency">
            <option *ngFor="let c of currencies" [value]="c.code">{{ c.label }} ({{ c.symbol }})</option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'settings.cardColor' | translate }}</label>
          <div class="card-color-picker" role="group" [attr.aria-label]="'settings.cardColor' | translate">
            <button type="button" *ngFor="let opt of cardColorOptions" class="card-color-swatch" [style.background]="opt.gradient" [class.selected]="editCardForm.color === opt.key" (click)="editCardForm.color = opt.key" [attr.aria-pressed]="editCardForm.color === opt.key" [attr.title]="opt.key"></button>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeEditCardModal()">{{ 'common.cancel' | translate }}</button>
          <button type="submit" class="btn btn-primary">{{ 'common.save' | translate }}</button>
        </div>
      </form>
    </app-modal>

    <!-- Section Compte -->
    <section class="settings-section section-account">
      <h2 class="section-heading">{{ 'settings.account' | translate }}</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'settings.userInfo' | translate }}</h3>
          <p *ngIf="currentUser">{{ currentUser.fullName }} ‚Äì {{ currentUser.email }}</p>
          <p *ngIf="!currentUser">{{ 'common.loading' | translate }}</p>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'nav.logout' | translate }}</h3>
          <p>{{ 'settings.logoutDesc' | translate }}</p>
        </div>
        <div class="setting-control">
          <button class="btn btn-danger" (click)="logout()">
            {{ 'settings.logoutBtn' | translate }}
          </button>
        </div>
      </div>
    </section>

    <!-- Section √Ä propos -->
    <section class="settings-section section-about">
      <h2 class="section-heading">{{ 'settings.about' | translate }}</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <h3>{{ 'settings.version' | translate }}</h3>
          <p>DailyFix v1.0.0</p>
        </div>
      </div>
    </section>
  </div>
</div>

