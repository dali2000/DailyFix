<div class="health-page">
  <h1>{{ 'health.title' | translate }}</h1>

  <div class="tabs">
    <button [class.active]="activeTab === 'overview'" (click)="activeTab = 'overview'">{{ 'health.overview' | translate }}</button>
    <button [class.active]="activeTab === 'meals'" (click)="activeTab = 'meals'">{{ 'health.meals' | translate }}</button>
    <button [class.active]="activeTab === 'activity'" (click)="activeTab = 'activity'">{{ 'health.activity' | translate }}</button>
    <button [class.active]="activeTab === 'sleep'" (click)="activeTab = 'sleep'">{{ 'health.sleep' | translate }}</button>
    <button [class.active]="activeTab === 'meditation'" (click)="activeTab = 'meditation'">{{ 'health.meditation' | translate }}</button>
  </div>

  <!-- Overview Tab -->
  <div *ngIf="activeTab === 'overview'" class="tab-content">
    <div class="health-score-card">
      <h2>{{ 'health.healthScore' | translate }}</h2>
      <div class="score-circle">
        <span class="score-value">{{ getHealthScore() }}%</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>{{ 'health.caloriesToday' | translate }}</h3>
        <p class="stat-value">{{ todayCalories }} kcal</p>
        <small>{{ 'health.goal' | translate }}: 2000 kcal</small>
      </div>
      <div class="stat-card">
        <h3>{{ 'health.physicalActivity' | translate }}</h3>
        <p class="stat-value">{{ todayActivityMinutes }} min</p>
        <small>{{ 'health.goal' | translate }}: 30 min/jour</small>
      </div>
      <div class="stat-card">
        <h3>{{ 'health.waterConsumed' | translate }}</h3>
        <p class="stat-value">{{ todayWaterIntake | number:'1.1-2' }} L</p>
        <small>{{ 'health.goal' | translate }}: 2 L/jour</small>
      </div>
      <div class="stat-card">
        <h3>{{ 'health.sleepLastNight' | translate }}</h3>
        <p class="stat-value">{{ lastSleepHours }}h</p>
        <small>{{ 'health.recommended' | translate }}: 7-9h</small>
      </div>
    </div>
  </div>

  <!-- Meals Tab -->
  <div *ngIf="activeTab === 'meals'" class="tab-content">
    <div class="section-header">
      <h2>{{ 'health.mealTracking' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showMealForm = true">+ {{ 'health.addMeal' | translate }}</button>
    </div>

    <div class="meals-list">
      <div *ngFor="let meal of meals.slice().reverse()" class="meal-card">
        <div class="meal-header">
          <h4>{{ meal.name }}</h4>
          <span class="meal-type">{{ meal.type }}</span>
        </div>
        <p *ngIf="meal.calories" class="calories">{{ meal.calories }} kcal</p>
        <p *ngIf="meal.notes" class="notes">{{ meal.notes }}</p>
        <small>{{ meal.date | date:'short' }}</small>
        <button class="btn btn-small btn-danger" (click)="deleteMeal(meal.id)">{{ 'common.delete' | translate }}</button>
      </div>
    </div>
  </div>

  <!-- Activity Tab -->
  <div *ngIf="activeTab === 'activity'" class="tab-content">
    <div class="section-header">
      <h2>Activité Physique</h2>
      <button type="button" class="btn btn-primary" (click)="showActivityForm = true">+ Ajouter une activité</button>
    </div>

    <div class="activities-list">
      <div *ngFor="let activity of activities.slice().reverse()" class="activity-card">
        <h4>{{ activity.type }}</h4>
        <p class="duration">{{ activity.duration }} {{ 'common.minutes' | translate }}</p>
        <p *ngIf="activity.calories" class="calories">{{ activity.calories }} {{ 'health.caloriesBurned' | translate }}</p>
        <p *ngIf="activity.notes" class="notes">{{ activity.notes }}</p>
        <small>{{ activity.date | date:'short' }}</small>
        <button class="btn btn-small btn-danger" (click)="deleteActivity(activity.id)">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Sleep Tab -->
  <div *ngIf="activeTab === 'sleep'" class="tab-content">
    <div class="section-header">
      <h2>{{ 'health.sleepTracking' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showSleepForm = true">+ {{ 'health.recordSleep' | translate }}</button>
    </div>

    <div class="sleep-records">
      <div *ngFor="let record of sleepRecords.slice().reverse()" class="sleep-card">
        <h4>{{ record.hours }} heures de sommeil</h4>
        <p>Coucher: {{ record.sleepTime | date:'short' }}</p>
        <p>Réveil: {{ record.wakeTime | date:'short' }}</p>
        <p>Qualité: {{ record.quality }}</p>
        <small>{{ record.date | date:'short' }}</small>
      </div>
    </div>
  </div>

  <!-- Meditation Tab -->
  <div *ngIf="activeTab === 'meditation'" class="tab-content">
    <div class="section-header">
      <h2>{{ 'health.meditationTitle' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showMeditationForm = true">+ {{ 'health.newSession' | translate }}</button>
    </div>

    <div class="meditation-sessions">
      <div *ngFor="let session of meditationSessions.slice().reverse()" class="meditation-card">
        <h4>{{ session.type }}</h4>
        <p class="duration">{{ session.duration }} minutes</p>
        <p *ngIf="session.notes" class="notes">{{ session.notes }}</p>
        <small>{{ session.date | date:'short' }}</small>
      </div>
    </div>
  </div>

  <!-- Water + Chat : petits carrés icônes uniquement -->
  <div class="water-quick-add">
    <button type="button" class="btn btn-icon-square" (click)="addOneCup()" [title]="'health.addOneCup' | translate" aria-label="Add 1 cup">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69z"/>
      </svg>
    </button>
    <button type="button" class="btn btn-icon-square" (click)="showWaterForm = true" [title]="'health.customAmount' | translate" aria-label="Custom amount">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
      </svg>
    </button>
    <button type="button" class="btn btn-icon-square" (click)="chatOpen = !chatOpen" [class.is-open]="chatOpen" [title]="'health.discussion' | translate" aria-label="Chat">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
      </svg>
    </button>
  </div>

  <!-- Fenêtre chat (s’ouvre au clic sur le bouton Chat) -->
  <div *ngIf="chatOpen" class="chatbot-panel chatbot-panel-floating">
    <div class="chatbot-panel-header">
      <h3>{{ 'health.discussionTitle' | translate }}</h3>
      <button type="button" class="chatbot-close" (click)="chatOpen = false" aria-label="Fermer">×</button>
    </div>
    <div *ngIf="!geminiAvailable" class="chatbot-unavailable">
      <p>{{ 'health.discussionUnavailable' | translate }}</p>
      <small>{{ 'health.discussionUnavailableHint' | translate }}</small>
    </div>
    <div *ngIf="geminiAvailable" class="chatbot-body">
      <div class="chatbot-messages">
        <div *ngFor="let msg of chatMessages" class="chat-row" [class.chat-row-user]="msg.role === 'user'" [class.chat-row-bot]="msg.role === 'model'">
          <div class="chat-bubble" [class.chat-bubble-user]="msg.role === 'user'" [class.chat-bubble-bot]="msg.role === 'model'">
            <span class="chat-bubble-label">{{ msg.role === 'user' ? ('health.you' | translate) : 'Gemini' }}</span>
            <div class="chat-bubble-text" [innerText]="msg.text"></div>
          </div>
        </div>
        <div *ngIf="chatLoading" class="chat-row chat-row-bot">
          <div class="chat-bubble chat-bubble-bot chat-bubble-loading">
            <span class="chat-bubble-label">Gemini</span>
            <div class="chat-bubble-text">{{ 'common.loading' | translate }}...</div>
          </div>
        </div>
      </div>
      <p *ngIf="chatError" class="chat-error">{{ chatError | translate }}</p>
      <form class="chatbot-form" (ngSubmit)="sendChatMessage()">
        <input type="text" [(ngModel)]="chatInput" name="chatInput" [placeholder]="'health.discussionPlaceholder' | translate" [disabled]="chatLoading" class="chat-input">
        <button type="submit" class="btn btn-primary chat-send" [disabled]="chatLoading || !chatInput.trim()">
          {{ 'health.send' | translate }}
        </button>
      </form>
    </div>
  </div>

  <!-- Health Modals -->
  <app-modal *ngIf="showMealForm" [title]="'health.addMeal' | translate" size="md" (closeModal)="closeMealModal()">
    <form (ngSubmit)="addMeal()">
      <div class="form-group">
        <label>{{ 'common.name' | translate }} *</label>
        <input type="text" [(ngModel)]="newMeal.name" name="name" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'calendar.type' | translate }}</label>
          <select [(ngModel)]="newMeal.type" name="type">
            <option value="breakfast">Petit-déjeuner</option>
            <option value="lunch">Déjeuner</option>
            <option value="dinner">Dîner</option>
            <option value="snack">Collation</option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'health.caloriesToday' | translate }}</label>
          <input type="number" [(ngModel)]="newMeal.calories" name="calories">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="newMeal.notes" name="notes" rows="2"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeMealModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <app-modal *ngIf="showActivityForm" [title]="'health.addActivity' | translate" size="md" (closeModal)="closeActivityModal()">
    <form (ngSubmit)="addActivity()">
      <div class="form-group">
        <label>{{ 'health.activityTitle' | translate }} *</label>
        <input type="text" [(ngModel)]="newActivity.type" name="type" placeholder="ex: Course, Natation, Yoga" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'common.minutes' | translate }} *</label>
          <input type="number" [(ngModel)]="newActivity.duration" name="duration" required>
        </div>
        <div class="form-group">
          <label>{{ 'health.caloriesBurned' | translate }}</label>
          <input type="number" [(ngModel)]="newActivity.calories" name="calories">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="newActivity.notes" name="notes" rows="2"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeActivityModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <app-modal *ngIf="showSleepForm" [title]="'health.recordSleep' | translate" size="md" (closeModal)="closeSleepModal()">
    <form (ngSubmit)="addSleepRecord()">
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'common.bedtime' | translate }} *</label>
          <input type="datetime-local" [(ngModel)]="newSleep.sleepTime" name="sleepTime" required>
        </div>
        <div class="form-group">
          <label>{{ 'common.wakeup' | translate }} *</label>
          <input type="datetime-local" [(ngModel)]="newSleep.wakeTime" name="wakeTime" required>
        </div>
      </div>
      <div class="form-group">
        <label>{{ 'common.quality' | translate }}</label>
        <select [(ngModel)]="newSleep.quality" name="quality">
          <option value="poor">Mauvaise</option>
          <option value="fair">Moyenne</option>
          <option value="good">Bonne</option>
          <option value="excellent">Excellente</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeSleepModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.save' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <app-modal *ngIf="showMeditationForm" [title]="'health.newSession' | translate" size="sm" (closeModal)="closeMeditationModal()">
    <form (ngSubmit)="addMeditationSession()">
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'health.minutesLabel' | translate }}</label>
          <input type="number" [(ngModel)]="newMeditation.duration" name="duration">
        </div>
        <div class="form-group">
          <label>{{ 'calendar.type' | translate }}</label>
          <select [(ngModel)]="newMeditation.type" name="type">
            <option value="guided">Guidée</option>
            <option value="breathing">Respiration</option>
            <option value="mindfulness">Pleine conscience</option>
            <option value="body-scan">Balayage corporel</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea [(ngModel)]="newMeditation.notes" name="notes" rows="2"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeMeditationModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.save' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <app-modal *ngIf="showWaterForm" [title]="'health.waterConsumed' | translate" size="sm" (closeModal)="closeWaterModal()">
    <form (ngSubmit)="addWaterIntake()">
      <div class="form-group">
        <label>{{ 'health.cupsLabel' | translate }}</label>
        <input type="number" [(ngModel)]="waterCups" name="waterCups" step="1" min="1" max="20" required>
        <small class="form-hint">({{ waterCupsToLiters | number:'1.2-2' }} L)</small>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeWaterModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
      </div>
    </form>
  </app-modal>
</div>


