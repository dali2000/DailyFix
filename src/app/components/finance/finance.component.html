<div class="finance-page">
  <h1>üí∞ {{ 'finance.title' | translate }}</h1>

  <!-- S√©lecteur de mois : gestion distincte par mois -->
  <div class="month-selector">
    <button type="button" class="btn btn-icon" (click)="goToPrevMonth()" [attr.aria-label]="'Mois pr√©c√©dent'">‚Äπ</button>
    <span class="month-label">{{ selectedMonthLabel }}</span>
    <button type="button" class="btn btn-icon" (click)="goToNextMonth()" [disabled]="!canGoToNextMonth" [attr.aria-label]="'Mois suivant'">‚Ä∫</button>
    <button type="button" class="btn btn-secondary btn-today" (click)="goToCurrentMonth()">{{ 'finance.thisMonth' | translate }}</button>
  </div>

  <div class="tabs">
    <button [class.active]="activeTab === 'overview'" (click)="activeTab = 'overview'">{{ 'finance.overview' | translate }}</button>
    <button [class.active]="activeTab === 'salary'" (click)="activeTab = 'salary'">{{ 'finance.salary' | translate }}</button>
    <button [class.active]="activeTab === 'expenses'" (click)="activeTab = 'expenses'">{{ 'finance.expenses' | translate }}</button>
    <button [class.active]="activeTab === 'budget'" (click)="activeTab = 'budget'">{{ 'finance.budget' | translate }}</button>
    <button [class.active]="activeTab === 'savings'" (click)="activeTab = 'savings'">{{ 'finance.savings' | translate }}</button>
  </div>

  <!-- Overview Tab : synth√®se du mois s√©lectionn√© -->
  <div *ngIf="activeTab === 'overview'" class="tab-content">
    <p class="month-context">{{ 'finance.forMonth' | translate }} {{ selectedMonthLabel }}</p>
    <!-- Bank Card -->
    <div class="bank-card" [class.negative-balance]="remainingBalance < 0">
      <div class="card-chip"></div>
      <div class="card-logo">DailyFix</div>
      <div class="card-number">{{ cardNumber }}</div>
      <div class="card-details">
        <div class="card-name-section">
          <div class="card-label">{{ 'finance.holder' | translate }}</div>
          <div class="card-name">{{ userName }}</div>
        </div>
        <div class="card-expiry-section">
          <div class="card-label">{{ 'finance.expires' | translate }}</div>
          <div class="card-expiry">{{ expiryDate }}</div>
        </div>
      </div>
      <div class="card-rib-section">
        <div class="card-label">RIB</div>
        <div class="card-rib">{{ rib }}</div>
      </div>
      <div class="card-balance">
        <div class="balance-label">{{ 'finance.availableBalance' | translate }}</div>
        <div class="balance-amount" [class.negative]="remainingBalance < 0">
          {{ remainingBalance | number:'1.2-2' }} {{ currencySymbol }}
        </div>
      </div>
    </div>

    <div class="overview-grid">
      <div class="overview-card income">
        <div class="card-icon">üíµ</div>
        <div class="card-content">
          <h3>{{ 'finance.income' | translate }}</h3>
          <p class="amount positive">{{ monthlySalary | number:'1.2-2' }} {{ currencySymbol }}</p>
        </div>
      </div>
      <div class="overview-card expenses">
        <div class="card-icon">üí∏</div>
        <div class="card-content">
          <h3>{{ 'finance.expenses' | translate }}</h3>
          <p class="amount negative">{{ monthlyExpenses | number:'1.2-2' }} {{ currencySymbol }}</p>
        </div>
      </div>
      <div class="overview-card balance" [class.negative]="remainingBalance < 0">
        <div class="card-icon">{{ remainingBalance >= 0 ? '‚úÖ' : '‚ö†Ô∏è' }}</div>
        <div class="card-content">
          <h3>Reste</h3>
          <p class="amount" [class.positive]="remainingBalance >= 0" [class.negative]="remainingBalance < 0">
            {{ remainingBalance | number:'1.2-2' }} {{ currencySymbol }}
          </p>
        </div>
      </div>
    </div>

    <div class="expenses-by-category">
      <h3>üìä {{ 'finance.expensesByCategory' | translate }}</h3>
      <div class="category-list">
        <div *ngFor="let category of expenseCategories" class="category-item">
          <div class="category-info">
            <span class="category-icon">{{ getCategoryIcon(category) }}</span>
            <span class="category-name">{{ getCategoryName(category) }}</span>
          </div>
          <span class="category-amount">{{ getExpensesByCategory(category) | number:'1.2-2' }} {{ currencySymbol }}</span>
        </div>
      </div>
    </div>

    <div *ngIf="savingsSuggestions.length > 0" class="suggestions-card">
      <h3>üí° {{ 'finance.savingsSuggestions' | translate }}</h3>
      <ul>
        <li *ngFor="let suggestion of savingsSuggestions">{{ suggestion }}</li>
      </ul>
    </div>
  </div>

  <!-- Salary Tab : salaires du mois s√©lectionn√© -->
  <div *ngIf="activeTab === 'salary'" class="tab-content">
    <p class="month-context">{{ 'finance.forMonth' | translate }} {{ selectedMonthLabel }}</p>
    <div class="section-header">
      <h2>üíµ Salaires</h2>
      <button type="button" class="btn btn-primary" (click)="openSalaryForm()">+ Ajouter un salaire</button>
    </div>

    <div class="salaries-list">
      <div *ngFor="let salary of salariesForMonth.slice().reverse()" class="salary-card">
        <div class="salary-header">
          <div class="salary-info">
            <h4>{{ salary.description || ('finance.salaryLabel' | translate) }}</h4>
            <span class="salary-period">{{ salary.period === 'monthly' ? ('common.monthly' | translate) : ('common.yearly' | translate) }}</span>
          </div>
          <span class="salary-amount positive">{{ salary.amount | number:'1.2-2' }} {{ currencySymbol }}</span>
        </div>
        <div class="salary-meta">
          <span class="date">{{ salary.date | date:'short' }}</span>
        </div>
        <button class="btn btn-small btn-danger" (click)="deleteSalary(salary.id)">Supprimer</button>
      </div>
      <div *ngIf="salariesForMonth.length === 0" class="empty-state">
        <p>Aucun salaire pour ce mois</p>
      </div>
    </div>
  </div>

  <!-- Expenses Tab : d√©penses du mois s√©lectionn√© -->
  <div *ngIf="activeTab === 'expenses'" class="tab-content">
    <p class="month-context">{{ 'finance.forMonth' | translate }} {{ selectedMonthLabel }}</p>
    <div class="section-header">
      <h2>üí∏ {{ 'finance.expenses' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="openExpenseForm()">+ {{ 'finance.addExpense' | translate }}</button>
    </div>

    <div class="expenses-list">
      <div *ngFor="let expense of expensesForMonth.slice().reverse()" class="expense-card">
        <div class="expense-header">
          <div class="expense-info">
            <span class="expense-icon">{{ getCategoryIcon(expense.category) }}</span>
            <h4>{{ expense.description }}</h4>
          </div>
          <span class="expense-amount negative">{{ expense.amount | number:'1.2-2' }} {{ currencySymbol }}</span>
        </div>
        <div class="expense-meta">
          <span class="category-badge">{{ getCategoryName(expense.category) }}</span>
          <span class="date">{{ expense.date | date:'short' }}</span>
        </div>
        <button class="btn btn-small btn-danger" (click)="deleteExpense(expense.id)">{{ 'common.delete' | translate }}</button>
      </div>
      <div *ngIf="expensesForMonth.length === 0" class="empty-state">
        <p>{{ 'finance.noExpense' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Budget Tab -->
  <div *ngIf="activeTab === 'budget'" class="tab-content">
    <div class="section-header">
      <h2>üìä {{ 'finance.budget' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showBudgetForm = true">+ {{ 'finance.newBudget' | translate }}</button>
    </div>

    <div class="budgets-list">
      <div *ngFor="let budget of budgets" class="budget-card">
        <div class="budget-header">
          <h4>{{ budget.category }}</h4>
          <span class="budget-period">{{ budget.period === 'monthly' ? ('common.monthly' | translate) : budget.period === 'weekly' ? ('common.weekly' | translate) : ('common.yearly' | translate) }}</span>
        </div>
        <div class="budget-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getBudgetProgress(budget)" [class.over-budget]="getBudgetProgress(budget) > 100"></div>
          </div>
          <div class="budget-amounts">
            <span>{{ budget.spent | number:'1.2-2' }} {{ currencySymbol }} / {{ budget.limit | number:'1.2-2' }} {{ currencySymbol }}</span>
            <span class="percentage" [class.over-budget]="getBudgetProgress(budget) > 100">{{ getBudgetProgress(budget) | number:'1.0-0' }}%</span>
          </div>
        </div>
        <button class="btn btn-small btn-danger" (click)="deleteBudget(budget.id)">Supprimer</button>
      </div>
      <div *ngIf="budgets.length === 0" class="empty-state">
        <p>Aucun budget d√©fini</p>
      </div>
    </div>
  </div>

  <!-- Savings Tab -->
  <div *ngIf="activeTab === 'savings'" class="tab-content">
    <div class="section-header">
      <h2>üéØ {{ 'finance.savingsGoalsTitle' | translate }}</h2>
      <button type="button" class="btn btn-primary" (click)="showSavingsForm = true">+ {{ 'finance.newSavingsGoal' | translate }}</button>
    </div>

    <div class="savings-goals-list">
      <div *ngFor="let goal of savingsGoals" class="savings-card">
        <div class="savings-header">
          <h4>{{ goal.name }}</h4>
          <span *ngIf="goal.deadline" class="deadline">{{ goal.deadline | date:'shortDate' }}</span>
        </div>
        <div class="savings-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getSavingsProgress(goal)"></div>
          </div>
          <div class="savings-amounts">
            <span>{{ goal.currentAmount | number:'1.2-2' }} {{ currencySymbol }} / {{ goal.targetAmount | number:'1.2-2' }} {{ currencySymbol }}</span>
            <span class="percentage">{{ getSavingsProgress(goal) | number:'1.0-0' }}%</span>
          </div>
        </div>
        <div class="savings-actions">
          <button type="button" class="btn btn-small btn-primary" (click)="openSavingsAdjust(goal, 'add')">
            + {{ 'finance.addAmount' | translate }}
          </button>
          <button type="button" class="btn btn-small btn-secondary" (click)="openSavingsAdjust(goal, 'decrease')">
            ‚àí {{ 'finance.decreaseAmount' | translate }}
          </button>
          <button class="btn btn-small btn-danger" (click)="deleteSavingsGoal(goal.id)">{{ 'common.delete' | translate }}</button>
        </div>
      </div>
      <div *ngIf="savingsGoals.length === 0" class="empty-state">
        <p>{{ 'finance.noSavingsGoal' | translate }}</p>
      </div>
    </div>
  </div>

  <!-- Salary Modal -->
  <app-modal *ngIf="showSalaryForm" [title]="'finance.newSalary' | translate" size="sm" (closeModal)="closeSalaryModal()">
    <form (ngSubmit)="addSalary()">
      <div class="form-group">
        <label>{{ 'common.amount' | translate }} ({{ currencySymbol }}) *</label>
        <input type="number" step="0.01" [(ngModel)]="newSalary.amount" name="amount" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>P√©riode *</label>
          <select [(ngModel)]="newSalary.period" name="period" required>
            <option value="monthly">Mensuel</option>
            <option value="yearly">Annuel</option>
          </select>
        </div>
        <div class="form-group">
          <label>{{ 'finance.dateLabel' | translate }}</label>
          <input type="date" [(ngModel)]="newSalary.date" name="date">
        </div>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" [(ngModel)]="newSalary.description" name="description" placeholder="Ex: Salaire principal">
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeSalaryModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>
  </app-modal>

  <!-- Expense Modal -->
  <app-modal *ngIf="showExpenseForm" [title]="'finance.newExpenseTitle' | translate" size="md" (closeModal)="closeExpenseModal()">
    <form (ngSubmit)="addExpense()">
      <div class="form-group">
        <label>{{ 'finance.descriptionLabel' | translate }} *</label>
        <input type="text" [(ngModel)]="newExpense.description" name="description" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'common.amount' | translate }} ({{ currencySymbol }}) *</label>
          <input type="number" step="0.01" [(ngModel)]="newExpense.amount" name="amount" required>
        </div>
        <div class="form-group">
          <label>{{ 'common.category' | translate }}</label>
          <select [(ngModel)]="newExpense.category" name="category">
            <option *ngFor="let cat of expenseCategories" [value]="cat">{{ getCategoryName(cat) }}</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>{{ 'finance.dateLabel' | translate }}</label>
        <input type="date" [(ngModel)]="newExpense.date" name="date">
      </div>
      <div class="form-group">
        <label>{{ 'finance.paymentMethod' | translate }}</label>
        <input type="text" [(ngModel)]="newExpense.paymentMethod" name="paymentMethod" [placeholder]="'finance.paymentPlaceholder' | translate">
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeExpenseModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.add' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <!-- Budget Modal -->
  <app-modal *ngIf="showBudgetForm" [title]="'finance.newBudgetTitle' | translate" size="sm" (closeModal)="closeBudgetModal()">
    <form (ngSubmit)="addBudget()">
      <div class="form-group">
        <label>{{ 'common.category' | translate }} *</label>
        <input type="text" [(ngModel)]="newBudget.category" name="category" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'common.amount' | translate }} ({{ currencySymbol }}) *</label>
          <input type="number" step="0.01" [(ngModel)]="newBudget.limit" name="limit" required>
        </div>
        <div class="form-group">
          <label>{{ 'common.period' | translate }}</label>
          <select [(ngModel)]="newBudget.period" name="period">
            <option value="weekly">{{ 'common.weekly' | translate }}</option>
            <option value="monthly">{{ 'common.monthly' | translate }}</option>
            <option value="yearly">{{ 'common.yearly' | translate }}</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeBudgetModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.create' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <!-- Savings Goal Modal -->
  <app-modal *ngIf="showSavingsForm" [title]="'finance.newSavingsGoalTitle' | translate" size="sm" (closeModal)="closeSavingsModal()">
    <form (ngSubmit)="addSavingsGoal()">
      <div class="form-group">
        <label>{{ 'common.name' | translate }} *</label>
        <input type="text" [(ngModel)]="newSavingsGoal.name" name="name" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>{{ 'finance.targetAmount' | translate }} ({{ currencySymbol }}) *</label>
          <input type="number" step="0.01" [(ngModel)]="newSavingsGoal.targetAmount" name="targetAmount" required>
        </div>
        <div class="form-group">
          <label>{{ 'finance.currentAmount' | translate }} ({{ currencySymbol }})</label>
          <input type="number" step="0.01" [(ngModel)]="newSavingsGoal.currentAmount" name="currentAmount">
        </div>
      </div>
      <div class="form-group">
        <label>{{ 'finance.deadline' | translate }}</label>
        <input type="date" [(ngModel)]="newSavingsGoal.deadline" name="deadline">
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeSavingsModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary">{{ 'common.create' | translate }}</button>
      </div>
    </form>
  </app-modal>

  <!-- Modal Ajouter / Retirer montant √©pargne -->
  <app-modal *ngIf="showSavingsAdjustModal && savingsAdjustGoal" [title]="savingsAdjustModalTitle" size="sm" (closeModal)="closeSavingsAdjustModal()">
    <form (ngSubmit)="submitSavingsAdjust()">
      <div class="form-group">
        <label>{{ (savingsAdjustOperation === 'add' ? 'finance.amountToAdd' : 'finance.amountToDecrease') | translate }} ({{ currencySymbol }}) *</label>
        <input type="number" step="0.01" min="0" [(ngModel)]="savingsAdjustAmount" name="savingsAdjustAmount" required>
      </div>
      <p class="savings-adjust-hint" *ngIf="savingsAdjustGoal">
        {{ 'finance.currentAmount' | translate }}: {{ savingsAdjustGoal.currentAmount | number:'1.2-2' }} {{ currencySymbol }}
      </p>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeSavingsAdjustModal()">{{ 'common.cancel' | translate }}</button>
        <button type="submit" class="btn btn-primary" [disabled]="savingsAdjustAmount <= 0">{{ 'common.save' | translate }}</button>
      </div>
    </form>
  </app-modal>
</div>
