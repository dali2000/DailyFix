import{Pa as f,Qa as S,a as r,b as a,j as d,n as g,o as l,p,s as D,v as m}from"./chunk-2PZ7RXZT.js";var y=(()=>{class c{constructor(t,e){this.authService=t,this.apiService=e,this.shoppingLists=[],this.householdTasks=[],this.authService.currentUser$.pipe(g()).subscribe(s=>{s!==null?this.loadAll():(this.shoppingLists=[],this.householdTasks=[])})}getShoppingLists(){return[...this.shoppingLists]}getShoppingListsObservable(){return this.apiService.get("/home/shopping-lists").pipe(d(t=>t.data||[]),d(t=>t.map(e=>{let s=[];if(e.items)if(Array.isArray(e.items))s=e.items;else if(typeof e.items=="string")try{s=JSON.parse(e.items)}catch(i){console.warn("Failed to parse items as JSON:",i),s=[]}else console.warn("Items is not an array or string:",e.items),s=[];return a(r({},e),{id:e.id.toString(),createdAt:new Date(e.createdAt),items:s.map((i,n)=>a(r({},i),{id:i.id?i.id.toString():`item_${e.id}_${n}_${Date.now()}`}))})})),p(t=>this.shoppingLists=t))}getShoppingListById(t){return this.shoppingLists.find(e=>e.id===t)}getShoppingListByIdObservable(t){let e=isNaN(Number(t))?t:Number(t);return this.apiService.get(`/home/shopping-lists/${e}`).pipe(d(s=>{let i=s.data,n=[];if(i.items)if(Array.isArray(i.items))n=i.items;else if(typeof i.items=="string")try{n=JSON.parse(i.items)}catch(o){console.warn("Failed to parse items as JSON:",o),n=[]}else console.warn("Items is not an array or string:",i.items),n=[];return a(r({},i),{id:i.id.toString(),createdAt:new Date(i.createdAt),items:n.map((o,u)=>a(r({},o),{id:o.id?o.id.toString():`item_${i.id}_${u}_${Date.now()}`}))})}))}addShoppingList(t){return this.apiService.post("/home/shopping-lists",t).pipe(d(e=>{let s=e.data;return a(r({},s),{id:s.id.toString(),createdAt:new Date(s.createdAt),items:(s.items||[]).map((i,n)=>a(r({},i),{id:i.id?i.id.toString():`item_${s.id}_${n}_${Date.now()}`}))})}),p(e=>{this.shoppingLists.push(e)}))}updateShoppingList(t,e){let s=isNaN(Number(t))?t:Number(t);return console.log("Updating shopping list:",s,e),this.apiService.put(`/home/shopping-lists/${s}`,e).pipe(d(i=>{let n=i.data,o=[];if(n.items)if(Array.isArray(n.items))o=n.items;else if(typeof n.items=="string")try{o=JSON.parse(n.items)}catch(h){console.warn("Failed to parse items as JSON:",h),o=[]}else console.warn("Items is not an array or string:",n.items),o=[];let u=a(r({},n),{id:n.id.toString(),createdAt:new Date(n.createdAt),items:o.map((h,w)=>a(r({},h),{id:h.id?h.id.toString():`item_${n.id}_${w}_${Date.now()}`}))});return console.log("Updated list received:",u),u}),p(i=>{let n=this.shoppingLists.findIndex(o=>o.id===t||o.id===i.id);n!==-1?this.shoppingLists[n]=i:this.shoppingLists.push(i)}))}deleteShoppingList(t){return this.apiService.delete(`/home/shopping-lists/${t}`).pipe(d(e=>e.success),p(()=>{let e=this.shoppingLists.findIndex(s=>s.id===t);e!==-1&&this.shoppingLists.splice(e,1)}))}getHouseholdTasks(){return[...this.householdTasks]}getHouseholdTasksObservable(){return this.apiService.get("/home/household-tasks").pipe(d(t=>t.data||[]),p(t=>this.householdTasks=t.map(e=>a(r({},e),{id:e.id.toString(),dueDate:e.dueDate?new Date(e.dueDate):void 0,lastCompleted:e.lastCompleted?new Date(e.lastCompleted):void 0,nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0}))))}getHouseholdTaskById(t){return this.householdTasks.find(e=>e.id===t)}getHouseholdTaskByIdObservable(t){return this.apiService.get(`/home/household-tasks/${t}`).pipe(d(e=>e.data))}addHouseholdTask(t){return this.apiService.post("/home/household-tasks",t).pipe(d(e=>e.data),p(e=>{this.householdTasks.push(a(r({},e),{id:e.id.toString(),dueDate:e.dueDate?new Date(e.dueDate):void 0,lastCompleted:e.lastCompleted?new Date(e.lastCompleted):void 0,nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0}))}))}updateHouseholdTask(t,e){return this.apiService.put(`/home/household-tasks/${t}`,e).pipe(d(s=>s.data),p(s=>{let i=this.householdTasks.findIndex(n=>n.id===t);i!==-1&&(this.householdTasks[i]=a(r({},s),{id:s.id.toString(),dueDate:s.dueDate?new Date(s.dueDate):void 0,lastCompleted:s.lastCompleted?new Date(s.lastCompleted):void 0,nextDueDate:s.nextDueDate?new Date(s.nextDueDate):void 0}))}))}deleteHouseholdTask(t){return this.apiService.delete(`/home/household-tasks/${t}`).pipe(d(e=>e.success),p(()=>{let e=this.householdTasks.findIndex(s=>s.id===t);e!==-1&&this.householdTasks.splice(e,1)}))}addItemToList(t,e){let s=this.shoppingLists.find(o=>o.id===t||o.id.toString()===t.toString());if(!s)return this.getShoppingListByIdObservable(t).pipe(l(o=>{let u=a(r({},e),{id:`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,purchased:e.purchased||!1}),h=[...o.items||[],u];return this.updateShoppingList(t,{items:h})}));let i=a(r({},e),{id:`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,purchased:e.purchased||!1}),n=[...s.items||[],i];return console.log("Adding item to list:",{listId:t,currentItems:s.items,newItem:i,updatedItems:n}),this.updateShoppingList(t,{items:n})}toggleItemPurchase(t,e){let s=this.shoppingLists.find(i=>i.id===t);if(s){let i=(s.items||[]).map(n=>n.id===e?a(r({},n),{purchased:!n.purchased}):n);return this.updateShoppingList(t,{items:i})}else return this.getShoppingListByIdObservable(t).pipe(d(i=>{let n=(i.items||[]).map(o=>o.id===e?a(r({},o),{purchased:!o.purchased}):o);return a(r({},i),{items:n})}),l(i=>this.updateShoppingList(t,{items:i.items})))}getUpcomingHouseholdTasks(){let t=new Date;return this.householdTasks.filter(e=>e.nextDueDate?(e.nextDueDate instanceof Date?e.nextDueDate:new Date(e.nextDueDate))>=t:!1).sort((e,s)=>{let i=e.nextDueDate instanceof Date?e.nextDueDate:e.nextDueDate?new Date(e.nextDueDate):new Date(0),n=s.nextDueDate instanceof Date?s.nextDueDate:s.nextDueDate?new Date(s.nextDueDate):new Date(0);return i.getTime()-n.getTime()})}loadAll(){this.authService.isAuthenticated()?(this.getShoppingListsObservable().subscribe({error:t=>console.error("Error loading shopping lists:",t)}),this.getHouseholdTasksObservable().subscribe({error:t=>console.error("Error loading household tasks:",t)})):(this.shoppingLists=[],this.householdTasks=[])}static{this.\u0275fac=function(e){return new(e||c)(m(S),m(f))}}static{this.\u0275prov=D({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{y as a};
